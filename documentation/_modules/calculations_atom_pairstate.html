

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>calculations_atom_pairstate &mdash; ARC - Alkali Rydberg Calculator 0.9 beta documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/arc_logo.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ARC - Alkali Rydberg Calculator 0.9 beta documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> ARC - Alkali Rydberg Calculator
          

          
            
            <img src="../_static/logo_small.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started with ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../detailed_doc.html">Detailed documentation of functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">How to contribute to the project</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ARC - Alkali Rydberg Calculator</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>calculations_atom_pairstate</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for calculations_atom_pairstate</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pair-state basis level diagram calculations</span>
<span class="sd">    </span>
<span class="sd">    Calculates Rydberg spaghetti of level diagrams, as well as pertubative C6 </span>
<span class="sd">    and similar properties. It also allows calculation of Foster resonances</span>
<span class="sd">    tuned by DC electric fields.</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>
<span class="sd">        Calculation of the Rydberg eigenstates in pair-state basis for Rubidium</span>
<span class="sd">        in the vicinity of the</span>
<span class="sd">        :math:`|60~S_{1/2}~m_j=1/2,~60~S_{1/2}~m_j=1/2\\rangle` state. Colour</span>
<span class="sd">        highlights coupling strength from state :math:`6~P_{1/2}~m_j=1/2` with</span>
<span class="sd">        :math:`\\pi` (:math:`q=0`) polarized light.</span>
<span class="sd">        eigenstates::</span>
<span class="sd">        </span>
<span class="sd">            from arc import *</span>
<span class="sd">            calc1 = PairStateInteractions(Rubidium(), 60, 0, 0.5, 60, 0, 0.5,0.5, 0.5)</span>
<span class="sd">            calc1.defineBasis( 0., 0., 4, 5,10e9)</span>
<span class="sd">            # optionally we can save now results of calculation for future use</span>
<span class="sd">            saveCalculation(calc1,&quot;mycalculation.pkl&quot;)</span>
<span class="sd">            calculation1.diagonalise(linspace(1,10.0,30),250,progressOutput = True,drivingFromState=[6,1,0.5,0.5,0])</span>
<span class="sd">            calc1.plotLevelDiagram()</span>
<span class="sd">            calc1.ax.set_xlim(1,10)</span>
<span class="sd">            calc1.ax.set_ylim(-2,2)</span>
<span class="sd">            calc1.showPlot()</span>
<span class="sd">    </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">exp</span><span class="p">,</span><span class="n">log</span><span class="p">,</span><span class="n">sqrt</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">__builtin__</span> <span class="k">import</span> <span class="kc">True</span>
<span class="kn">from</span> <span class="nn">astropy.units</span> <span class="k">import</span> <span class="n">ymin</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.minor.visible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.minor.visible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.major.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.major.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.minor.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.minor.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>

<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="k">import</span> <span class="n">MultipleLocator</span><span class="p">,</span> <span class="n">FormatStrFormatter</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">wigner</span> <span class="k">import</span> <span class="n">Wigner6j</span><span class="p">,</span><span class="n">Wigner3j</span><span class="p">,</span><span class="n">CG</span><span class="p">,</span><span class="n">wignerDmatrix</span>
<span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="k">import</span> <span class="n">physical_constants</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">epsilon_0</span><span class="p">,</span><span class="n">hbar</span>
<span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="k">import</span> <span class="n">e</span> <span class="k">as</span> <span class="n">elemCharge</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span>

<span class="c1"># for matrices</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">savetxt</span><span class="p">,</span> <span class="n">complex64</span><span class="p">,</span><span class="n">complex128</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">eigvalsh</span><span class="p">,</span><span class="n">eig</span><span class="p">,</span><span class="n">eigh</span>
<span class="kn">from</span> <span class="nn">numpy.ma</span> <span class="k">import</span> <span class="n">conjugate</span>
<span class="kn">from</span> <span class="nn">numpy.lib.polynomial</span> <span class="k">import</span> <span class="n">real</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="k">import</span> <span class="n">lil_matrix</span><span class="p">,</span><span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="k">import</span> <span class="n">eigsh</span>
<span class="kn">from</span> <span class="nn">scipy.special.specfun</span> <span class="k">import</span> <span class="n">fcoef</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">floor</span>

<span class="c1">#from scipy.integrate import ode</span>
<span class="kn">from</span> <span class="nn">alkali_atom_functions</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">alkali_atom_functions</span> <span class="k">import</span> <span class="n">_EFieldCoupling</span><span class="p">,</span><span class="n">_atomLightAtomCoupling</span>
<span class="kn">from</span> <span class="nn">calculations_atom_single</span> <span class="k">import</span> <span class="n">StarkMap</span>

<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="k">import</span> <span class="n">LinearSegmentedColormap</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>

<span class="kn">import</span> <span class="nn">gzip</span>

<div class="viewcode-block" id="PairStateInteractions"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions">[docs]</a><span class="k">class</span> <span class="nc">PairStateInteractions</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates Rydberg level diagram (spaghetti) for the given pair state</span>
<span class="sd">        </span>
<span class="sd">        Initializes Rydberg level spaghetti calculation for the given atom in </span>
<span class="sd">        the vicinity of the given pair state. For details of calculation see</span>
<span class="sd">        Ref. [1]_. For a quick start point example see </span>
<span class="sd">        `interactions example snippet`_.</span>
<span class="sd">        </span>
<span class="sd">        .. _`interactions example snippet`:</span>
<span class="sd">            ./Rydberg_atoms_a_primer.html#Short-range-interactions</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            atom (:obj:`AlkaliAtom`): ={ :obj:`alkali_atom_data.Lithium6`, </span>
<span class="sd">                :obj:`alkali_atom_data.Lithium6`,</span>
<span class="sd">                :obj:`alkali_atom_data.Sodium`,</span>
<span class="sd">                :obj:`alkali_atom_data.Potassium`,</span>
<span class="sd">                :obj:`alkali_atom_data.Rubidium`,</span>
<span class="sd">                :obj:`alkali_atom_data.Caesium` } </span>
<span class="sd">                Select the alkali metal for energy level </span>
<span class="sd">                diagram calculation</span>
<span class="sd">            n (int): principal quantum number for the *first* atom</span>
<span class="sd">            l (int): orbital angular momentum for the *first* atom</span>
<span class="sd">            j (float): total angular momentum for the *first* atom</span>
<span class="sd">            nn (int): principal quantum number for the *second* atom</span>
<span class="sd">            ll (int): orbital angular momentum for the *second* atom</span>
<span class="sd">            jj (float): total angular momentum for the *second* atom</span>
<span class="sd">            m1 (float): projection of the total angular momentum on z-axis</span>
<span class="sd">                for the *first* atom</span>
<span class="sd">            m2 (float): projection of the total angular momentum on z-axis</span>
<span class="sd">                for the *second* atom</span>
<span class="sd">            interactionsUpTo (int): Optional. If set to 1, includes only </span>
<span class="sd">                dipole-dipole interactions. If set to 2 includes interactions</span>
<span class="sd">                up to quadrupole-quadrupole. Default value is 1.</span>
<span class="sd">                </span>
<span class="sd">        References:</span>
<span class="sd">            .. [1] T. G Walker, M. Saffman, PRA **77**, 032723 (2008)</span>
<span class="sd">                https://doi.org/10.1103/PhysRevA.77.032723</span>
<span class="sd">                </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">dataFolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span>\
                              <span class="s2">&quot;data&quot;</span><span class="p">)</span>
    
    <span class="c1"># =============================== Methods ===============================</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">atom</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">nn</span><span class="p">,</span><span class="n">ll</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">interactionsUpTo</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># alkali atom type, principal quantum number, orbital angular momentum,</span>
        <span class="c1">#  total angular momentum projections of the angular momentum on z axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">atom</span>  <span class="c1">#: atom type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="c1">#: pair-state definition: principal quantum number of the first atom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">l</span> <span class="c1">#: pair-state definition: orbital angular momentum of the first atom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="c1">#: pair-state definition: total angular momentum of the first atom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn</span> <span class="o">=</span> <span class="n">nn</span> <span class="c1">#: pair-state definition: principal quantum number of the second atom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ll</span> <span class="o">=</span> <span class="n">ll</span> <span class="c1">#: pair-state definition: orbital angular momentum of the second atom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jj</span> <span class="o">=</span> <span class="n">jj</span> <span class="c1">#: pair-state definition: total angular momentum of the second atom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m1</span> <span class="o">=</span> <span class="n">m1</span> <span class="c1">#: pair-state definition: projection of the total ang. momentum for the *first* atom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span> <span class="o">=</span> <span class="n">m2</span> <span class="c1">#: pair-state definition: projection of the total angular momentum for the *second* atom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span> <span class="o">=</span> <span class="n">interactionsUpTo</span>
        <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">            Specifies up to which approximation we include in pair-state interactions.</span>
<span class="sd">            By default value is 1, corresponding to pair-state interactions up to</span>
<span class="sd">            dipole-dipole coupling. Value of 2 is also supported, corresponding </span>
<span class="sd">            to pair-state interactions up to quadrupole-quadrupole coupling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># ====================== J basis (not resolving mj) ======================</span>
         
        <span class="bp">self</span><span class="o">.</span><span class="n">coupling</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            List of matrices defineing coupling strengths between the states in J basis (not </span>
<span class="sd">            resolving :math:`m_j` ). Basis is given by :obj:`channel`. Used as </span>
<span class="sd">            intermediary for full interaction matrix calculation by </span>
<span class="sd">            :obj:`defineBasis`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            states relevant for calculation, defined in J basis (not resolving </span>
<span class="sd">            :math:`m_j`. Used as intermediary for full interaction matrix </span>
<span class="sd">            calculation by :obj:`defineBasis`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="c1"># ======================= Full basis (resolving mj) =======================</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            List of pair-states for calculation. Each state is array</span>
<span class="sd">            [n1,l1,j1,mj1,n2,l2,j2,mj2] corresponding to </span>
<span class="sd">            :math:`|n_1,l_1,j_1,m_{j1},n_2,l_2,j_2,m_{j2}\\rangle` state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matrixElement</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            `matrixElement[i]` gives index of state in :obj:`channel` basis (that </span>
<span class="sd">            doesn&#39;t resolve :obj:`m_j` states), for the given index `i` of the </span>
<span class="sd">            state in :obj:`states`  ( :math:`m_j` resolving) basis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># variuos parts of interaction matrix in pair-state basis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matDiagonal</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Part of interaction matrix in pair-state basis that doesn&#39;t depend</span>
<span class="sd">            on inter-atomic distance. E.g. diagonal elements of the interaction</span>
<span class="sd">            matrix, that describe energies of the pair states in unperturbed basis,</span>
<span class="sd">            will be stored here. Calculated by :obj:`defineBasis`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matR3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Part of the interaction matrix in pair-state basis that scales as</span>
<span class="sd">            :math:`1/R^3` with distance. E.g. dipole-dipole interaction</span>
<span class="sd">            coefficients ( :math:`C_3`) will be stored here.</span>
<span class="sd">            will be stored here. Calculated by :obj:`defineBasis`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matR4</span> <span class="o">=</span> <span class="p">[]</span>  
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Part of the interaction matrix in pair-state basis that scales as</span>
<span class="sd">            :math:`1/R^3` with distance. E.g. dipole-quadrupole interaction</span>
<span class="sd">            coefficients ( :math:`C_4`) will be stored here.</span>
<span class="sd">            will be stored here. Calculated by :obj:`defineBasis`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matR5</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Part of the interaction matrix in pair-state basis that scales as</span>
<span class="sd">            :math:`1/R^5` with distance. E.g. quadrupole-quadrupole interaction</span>
<span class="sd">            coefficients ( :math:`C_5`) will be stored here.</span>
<span class="sd">            will be stored here</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            index of the original n,l,j,m1,nn,ll,jj,m2 pair-state in the</span>
<span class="sd">            :obj:`states` basis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">matE</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matB_1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matB_2</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># ====================== Eigen states and plotting ======================</span>
        
        <span class="c1"># finding perturbed energy levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># detuning scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># energy levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highlight</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># pointers towards figure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># for normalization of the maximum coupling later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxCoupling</span> <span class="o">=</span> <span class="mf">0.</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">drivingFromState</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># n,l,j,mj, drive polarization q</span>
        
        <span class="c1">#sam = saved angular matrix metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angularMatrixFile</span> <span class="o">=</span> <span class="s2">&quot;angularMatrix.pkl&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angularMatrixFile_meta</span> <span class="o">=</span> <span class="s2">&quot;angularMatrix_meta.pkl&quot;</span>
        <span class="c1">#self.sam = []</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedAngularMatrix_matrix</span> <span class="o">=</span> <span class="p">[]</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__getAngularMatrix_M</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ll</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="n">atom</span><span class="p">):</span>
        <span class="c1"># did we already calculated this matrix?</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;SELECT ind FROM pair_angularMatrix WHERE</span>
<span class="s1">             l1 = ? AND j1_x2 = ? AND </span>
<span class="s1">             l2 = ? AND j2_x2 = ? AND </span>
<span class="s1">             l3 = ? AND j3_x2 = ? AND </span>
<span class="s1">             l4 = ? AND j4_x2 = ?  </span>
<span class="s1">             &#39;&#39;&#39;</span><span class="p">,(</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">ll</span><span class="p">,</span><span class="n">jj</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">savedAngularMatrix_matrix</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                 
        <span class="c1"># determine coupling</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">l1</span><span class="p">)</span>
        <span class="n">dj</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">j1</span><span class="p">)</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">dl</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dj</span><span class="o">&lt;</span><span class="mf">1.1</span><span class="p">):</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># dipole coupling</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">dl</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">dl</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">dl</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># quadrupole coupling</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;error in __getAngularMatrix_M&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ll</span><span class="o">-</span><span class="n">l2</span><span class="p">)</span>
        <span class="n">dj</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jj</span><span class="o">-</span><span class="n">j2</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">dl</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dj</span><span class="o">&lt;</span><span class="mf">1.1</span><span class="p">):</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># dipole coupling</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">dl</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">dl</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">dl</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># quadrupole coupling</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;error in __getAngularMatrix_M&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>                  
                
        <span class="c1">##fcoef = lambda l1,l2,m: factorial(l1+l2)/(factorial(l1+m)*factorial(l1-m)*factorial(l2+m)*factorial(l2-m))**0.5</span>
        <span class="c1"># fcp[c1,c2,p+2] = fcoef(c1,c2,p) precalculated to speed up calculation</span>
        <span class="n">fcp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>\
                        <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>\
                         <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]],</span>\
                       <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        
        <span class="n">am</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">j1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">j2</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">)),</span>\
                    <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">))),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        
        <span class="n">j1range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">j1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">j1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">j2range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">j2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">j2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">jrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">jjrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">jj</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">jj</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">m1</span> <span class="ow">in</span> <span class="n">j1range</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m2</span> <span class="ow">in</span> <span class="n">j2range</span><span class="p">:</span>
                <span class="c1"># we have chosen the first index</span>
                <span class="n">index1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">m1</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">j2</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">+</span><span class="n">m2</span><span class="o">+</span><span class="p">(</span><span class="n">j1</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">j2</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">+</span><span class="n">j2</span><span class="p">),</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">jrange</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="n">jjrange</span><span class="p">:</span>
                        <span class="c1"># we have chosen the second index</span>
                        <span class="n">index2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">jj</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">+</span><span class="n">mm</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">jj</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">+</span><span class="n">jj</span><span class="p">),</span><span class="mi">0</span><span class="p">))</span>
                        
                        
                        <span class="c1"># angular matrix element from Sa??mannshausen, Heiner, Merkt, Fr??d??ric, Deiglmayr, Johannes</span>
                        <span class="c1"># PRA 92: 032505 (2015)</span>
                        <span class="n">elem</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="n">jj</span><span class="o">+</span><span class="mf">1.0</span><span class="o">+</span><span class="n">l1</span><span class="o">+</span><span class="n">l2</span><span class="p">)</span><span class="o">*</span><span class="n">CG</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">CG</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">elem</span> <span class="o">=</span> <span class="n">elem</span><span class="o">*</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">ll</span><span class="o">+</span><span class="mf">1.0</span><span class="p">))</span><span class="o">*</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">2.0</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">jj</span><span class="o">+</span><span class="mf">1.0</span><span class="p">))</span>
                        <span class="n">elem</span> <span class="o">=</span> <span class="n">elem</span><span class="o">*</span><span class="n">Wigner6j</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">l1</span><span class="p">)</span><span class="o">*</span><span class="n">Wigner6j</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">l2</span><span class="p">)</span>

                        <span class="n">sumPol</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># sum over polarisations</span>
                        <span class="n">limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="o">-</span><span class="n">limit</span><span class="p">,</span><span class="n">limit</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">sumPol</span> <span class="o">=</span> <span class="n">sumPol</span> <span class="o">+</span> <span class="n">fcp</span><span class="p">[</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">p</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">CG</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">m1</span><span class="p">)</span><span class="o">*</span><span class="n">CG</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span><span class="n">mm</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="o">-</span><span class="n">p</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="n">m2</span><span class="p">)</span>
                        <span class="n">am</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span><span class="n">index2</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="o">*</span><span class="n">sumPol</span>
        
        <span class="c1">#am = csr_matrix(am)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savedAngularMatrix_matrix</span><span class="p">)</span>

        <span class="c1">#print &quot;inserting&quot;</span>
        <span class="c1">#print [l,j*2,ll,jj*2,l1,j1*2,l2,j2*2,index]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39; INSERT INTO pair_angularMatrix </span>
<span class="s1">                            VALUES (?,?, ?,?, ?,?, ?,?, ?)&#39;&#39;&#39;</span><span class="p">,</span>\
                       <span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">ll</span><span class="p">,</span><span class="n">jj</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">index</span><span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">savedAngularMatrix_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">am</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">savedAngularMatrixChanged</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">am</span>
    
    <span class="k">def</span> <span class="nf">__updateAngularMatrixElementsFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savedAngularMatrixChanged</span><span class="p">):</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;SELECT * FROM pair_angularMatrix &#39;&#39;&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            
            <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">2.</span>  <span class="c1"># 2 r j1 -&gt; j1 </span>
            <span class="n">data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">2.</span>  <span class="c1"># 2 r j2 -&gt; j2</span>
            <span class="n">data</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">2.</span>  <span class="c1"># 2 r j3 -&gt; j3</span>
            <span class="n">data</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">2.</span>  <span class="c1"># 2 r j4 -&gt; j4</span>
            
            
            <span class="n">fileHandle</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFolder</span><span class="p">,</span>\
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">angularMatrixFile_meta</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">fileHandle</span><span class="p">,</span>\
                        <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span> 
            <span class="n">fileHandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Error while updating angularMatrix </span><span class="se">\</span>
<span class="s2">                data meta (description) File &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">angularMatrixFile_meta</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fileHandle</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFolder</span><span class="p">,</span>\
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">angularMatrixFile</span><span class="p">),</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savedAngularMatrix_matrix</span><span class="p">,</span><span class="n">fileHandle</span><span class="p">,</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
            <span class="n">fileHandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Error while updating angularMatrix </span><span class="se">\</span>
<span class="s2">                    data File &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">angularMatrixFile</span>
            <span class="nb">print</span> <span class="n">e</span>
    
    <span class="k">def</span> <span class="nf">__loadAngularMatrixElementsFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">fileHandle</span> <span class="o">=</span>  <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFolder</span><span class="p">,</span>\
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">angularMatrixFile_meta</span><span class="p">),</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fileHandle</span><span class="p">)</span>
        <span class="n">fileHandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># j1 -&gt; 2 r j1 </span>
        <span class="n">data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># j2 -&gt; 2 r j2 </span>
        <span class="n">data</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># j3 -&gt; 2 r j3 </span>
        <span class="n">data</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># j4 -&gt; 2 r j4 </span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span> 

            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;INSERT INTO pair_angularMatrix</span>
<span class="s1">                (l1, j1_x2 , </span>
<span class="s1">                 l2 , j2_x2 , </span>
<span class="s1">                 l3, j3_x2, </span>
<span class="s1">                 l4 , j4_x2 , </span>
<span class="s1">                 ind)</span>
<span class="s1">                      VALUES (?,?,?,?,?,?,?,?,?)&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Error while loading precalculated values into the database!&quot;</span>
            <span class="nb">print</span> <span class="n">e</span>
            <span class="n">exit</span><span class="p">()</span>  
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;error&quot;</span>
            <span class="k">return</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fileHandle</span> <span class="o">=</span>  <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFolder</span><span class="p">,</span>\
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">angularMatrixFile</span><span class="p">),</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savedAngularMatrix_matrix</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fileHandle</span><span class="p">)</span>
            <span class="n">fileHandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Note: No saved angular matrix files to be loaded.&quot;</span>
            <span class="nb">print</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

    
    <span class="k">def</span> <span class="nf">__isCoupled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">nn</span><span class="p">,</span><span class="n">ll</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="n">limit</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">getEnergyDefect2</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">nn</span><span class="p">,</span><span class="n">ll</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">))</span><span class="o">/</span><span class="n">h</span><span class="o">&lt;</span><span class="n">limit</span><span class="p">)</span> <span class="ow">and</span>\
                <span class="ow">not</span> <span class="p">(</span><span class="n">n</span><span class="o">==</span><span class="n">n1</span> <span class="ow">and</span> <span class="n">nn</span><span class="o">==</span><span class="n">n2</span> <span class="ow">and</span> <span class="n">l</span><span class="o">==</span><span class="n">l1</span> <span class="ow">and</span> <span class="n">ll</span><span class="o">==</span><span class="n">l2</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="n">j1</span> <span class="ow">and</span> <span class="n">jj</span><span class="o">==</span><span class="n">j2</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">l1</span><span class="o">-</span><span class="n">l</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">j1</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="p">)</span> <span class="ow">or</span> 
                         <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">l2</span><span class="o">-</span><span class="n">ll</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jj</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">j2</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="p">)):</span>
                            <span class="c1"># determine coupling</span>
                <span class="n">dl</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">l1</span><span class="p">)</span>
                <span class="n">dj</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">j1</span><span class="p">)</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">dl</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dj</span><span class="o">&lt;</span><span class="mf">1.1</span><span class="p">):</span>
                    <span class="n">c1</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># dipole coupling</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">dl</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">dl</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">dl</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="ow">and</span> <span class="p">(</span><span class="n">dj</span><span class="o">&lt;</span><span class="mf">2.1</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span><span class="p">):</span>
                    <span class="n">c1</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># quadrupole coupling</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="n">dl</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ll</span><span class="o">-</span><span class="n">l2</span><span class="p">)</span>
                <span class="n">dj</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jj</span><span class="o">-</span><span class="n">j2</span><span class="p">)</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">dl</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dj</span><span class="o">&lt;</span><span class="mf">1.1</span><span class="p">):</span>
                    <span class="n">c2</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># dipole coupling</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">dl</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">dl</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">dl</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dj</span><span class="o">&lt;</span><span class="mf">2.1</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span><span class="p">):</span>
                    <span class="n">c2</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># quadrupole coupling</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>                                    
                <span class="k">return</span> <span class="n">c1</span><span class="o">+</span><span class="n">c2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">__makeRawMatrix2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">nn</span><span class="p">,</span><span class="n">ll</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">lrange</span><span class="p">,</span><span class="n">limit</span><span class="p">,</span><span class="n">limitBasisToMj</span><span class="p">,</span>\
                         <span class="n">progressOutput</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">debugOutput</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># limit = limit in Hz on energy defect </span>
        <span class="c1"># k defines range of n&#39; = [n-k, n+k]</span>
        <span class="n">dimension</span> <span class="o">=</span> <span class="mi">0</span>

        
        <span class="c1"># which states/channels contribute significantly in the second order pertubation?</span>
        <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># original pairstate index</span>
        <span class="n">opi</span> <span class="o">=</span> <span class="mi">0</span>
        
        
        <span class="c1"># this numbers are conserved if we use only dipole-dipole interactions</span>
        <span class="n">Lmod2</span> <span class="o">=</span> <span class="p">((</span><span class="n">l</span><span class="o">+</span><span class="n">ll</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">l1start</span> <span class="o">=</span> <span class="n">l</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">l1start</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="n">l2start</span> <span class="o">=</span> <span class="n">ll</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ll</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">l2start</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">debugOutput</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> ======= Relevant states =======</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">n1</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">n</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">n2</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">nn</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">l1max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span><span class="p">,</span><span class="n">lrange</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">l1max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">l1max</span><span class="p">,</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">l1</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">l1start</span><span class="p">,</span><span class="n">l1max</span><span class="p">):</span>
                    <span class="n">l2max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ll</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span><span class="p">,</span><span class="n">lrange</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">l2max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">l2max</span><span class="p">,</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">l2</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">l2start</span><span class="p">,</span><span class="n">l2max</span><span class="p">):</span>
                        <span class="n">j1</span> <span class="o">=</span> <span class="n">l1</span><span class="o">-</span><span class="mf">0.5</span>
                        <span class="k">if</span> <span class="n">l1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">j1</span> <span class="o">=</span> <span class="mf">0.5</span>
                        <span class="k">while</span> <span class="n">j1</span> <span class="o">&lt;=</span> <span class="n">l1</span><span class="o">+</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.1</span><span class="p">:</span>
                            <span class="n">j2</span> <span class="o">=</span> <span class="n">l2</span><span class="o">-</span><span class="mf">0.5</span>
                            <span class="k">if</span> <span class="n">l2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">j2</span> <span class="o">=</span> <span class="mf">0.5</span>
                            
                            <span class="k">while</span> <span class="n">j2</span> <span class="o">&lt;=</span> <span class="n">l2</span><span class="o">+</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.1</span><span class="p">:</span>
                                <span class="n">ed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">getEnergyDefect2</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="p">,</span>\
                                                               <span class="n">nn</span><span class="p">,</span><span class="n">ll</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span>\
                                                               <span class="n">n1</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span>\
                                                               <span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">)</span><span class="o">/</span><span class="n">h</span>
                                <span class="k">if</span>  <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ed</span><span class="p">)</span><span class="o">&lt;</span><span class="n">limit</span>  \
                                    <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span>\
                                         <span class="p">(</span><span class="n">Lmod2</span> <span class="o">==</span> <span class="p">((</span><span class="n">l1</span><span class="o">+</span><span class="n">l2</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                                    <span class="ow">and</span> <span class="p">((</span><span class="ow">not</span> <span class="n">limitBasisToMj</span><span class="p">)</span> <span class="ow">or</span> \
                                         <span class="p">(</span><span class="n">j1</span><span class="o">+</span><span class="n">j2</span><span class="o">+</span><span class="mf">0.1</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">m1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">)</span> <span class="p">)</span>    <span class="p">):</span> 
                                    
                                    <span class="k">if</span> <span class="n">debugOutput</span><span class="p">:</span>
                                        <span class="n">pairState</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">+</span><span class="n">printStateString</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">)</span><span class="o">+</span>\
                                                <span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="n">printStateString</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&gt;&quot;</span>
                                        <span class="nb">print</span> <span class="n">pairState</span><span class="o">+</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> EnergyDefect = </span><span class="si">%.3f</span><span class="s2"> GHz&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ed</span><span class="o">*</span><span class="mf">1.e-9</span><span class="p">))</span>
                                    
                                    <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">n1</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">])</span>
                                    
                                    
                                    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">==</span><span class="n">n1</span> <span class="ow">and</span> <span class="n">nn</span><span class="o">==</span><span class="n">n2</span> <span class="ow">and</span> <span class="n">l</span><span class="o">==</span><span class="n">l1</span> <span class="ow">and</span>\
                                         <span class="n">ll</span><span class="o">==</span><span class="n">l2</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="n">j1</span> <span class="ow">and</span> <span class="n">jj</span><span class="o">==</span><span class="n">j2</span><span class="p">):</span>
                                        <span class="n">opi</span> <span class="o">=</span> <span class="n">dimension</span>
                                    
                                    <span class="n">dimension</span> <span class="o">=</span> <span class="n">dimension</span> <span class="o">+</span><span class="mi">1</span>
                                <span class="n">j2</span> <span class="o">=</span> <span class="n">j2</span><span class="o">+</span><span class="mf">1.0</span>
                            <span class="n">j1</span> <span class="o">=</span> <span class="n">j1</span><span class="o">+</span><span class="mf">1.0</span>
        
        <span class="c1">#print opi</span>
        <span class="c1">#print states[opi]</span>
        
        <span class="k">if</span> <span class="n">debugOutput</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Matrix dimension</span><span class="se">\t</span><span class="s2">=</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">dimension</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dimension</span><span class="p">,</span><span class="n">dimension</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># mat_value, mat_row, mat_column for each sparce matrix describing</span>
        <span class="c1"># dipole-dipole, dipole-quadrupole (and quad-dipole) and quadrupole-quadrupole</span>
        <span class="n">couplingMatConstructor</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[[],[],[]]</span> \
                                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span>
        
        

        
        <span class="k">if</span> <span class="n">debugOutput</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> ======= Coupling strengths (radial part only) =======</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="n">maxCoupling</span> <span class="o">=</span> <span class="s2">&quot;quadrupole-quadrupole&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">maxCoupling</span> <span class="o">=</span> <span class="s2">&quot;dipole-dipole&quot;</span>
        <span class="k">if</span> <span class="n">debugOutput</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Calculating coupling (up to &quot;</span><span class="p">,</span><span class="n">maxCoupling</span><span class="p">,</span><span class="s2">&quot;) between the pair states&quot;</span>
                    
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">dimension</span><span class="p">):</span>
            
            <span class="n">ed</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">getEnergyDefect2</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">opi</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">opi</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">opi</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                          <span class="n">states</span><span class="p">[</span><span class="n">opi</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">opi</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">opi</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span>
                                          <span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                          <span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="n">h</span><span class="o">*</span><span class="mf">1.0e-9</span>

            <span class="n">pairState1</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">+</span><span class="n">printStateString</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span>\
                        <span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="n">printStateString</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;&gt;&quot;</span>
    
            <span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ed</span><span class="p">)</span>  <span class="c1"># energy defect of given state</span>
            <span class="c1">#m[i,i] = ed</span>
            <span class="c1">#m_value.append(ed)</span>
            <span class="c1">#m_row.append(i)</span>
            <span class="c1">#m_column.append(j)</span>
            
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dimension</span><span class="p">):</span>
                
                <span class="n">coupled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isCoupled</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                            <span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span>
                                            <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                             <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="n">limit</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">24</span> <span class="ow">and</span> <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">18</span><span class="p">):</span>
                    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="nb">print</span> <span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="nb">print</span> <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="nb">print</span> <span class="n">coupled</span>
                
                
                <span class="k">if</span> <span class="n">coupled</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">k</span> <span class="ow">and</span>\
                                <span class="nb">abs</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">k</span> <span class="p">):</span>
                    <span class="n">pairState2</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">+</span><span class="n">printStateString</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span>\
                                <span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="n">printStateString</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">5</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;&gt;&quot;</span>
                    <span class="k">if</span> <span class="n">debugOutput</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="n">pairState1</span><span class="o">+</span><span class="s2">&quot; &lt;---&gt; &quot;</span><span class="o">+</span><span class="n">pairState2</span>
                    
                    <span class="n">couplingStregth</span> <span class="o">=</span> <span class="n">_atomLightAtomCoupling</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                            <span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span>
                                            <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                             <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span><span class="o">/</span><span class="n">h</span><span class="o">*</span><span class="mf">1.0e-9</span> <span class="c1"># /h*1.0e9</span>
                    
                    <span class="n">couplingMatConstructor</span><span class="p">[</span><span class="n">coupled</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">couplingStregth</span><span class="p">)</span>
                    <span class="n">couplingMatConstructor</span><span class="p">[</span><span class="n">coupled</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">couplingMatConstructor</span><span class="p">[</span><span class="n">coupled</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    
                    <span class="n">exponent</span> <span class="o">=</span> <span class="n">coupled</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">debugOutput</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">coupling (C_</span><span class="si">%d</span><span class="s2">/R^</span><span class="si">%d</span><span class="s2">) = </span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">exponent</span><span class="p">,</span><span class="n">exponent</span><span class="p">,</span><span class="n">couplingStregth</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="n">e6</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">exponent</span><span class="p">))),</span>\
                            <span class="s2">&quot;/R^&quot;</span><span class="p">,</span><span class="n">exponent</span><span class="p">,</span><span class="s2">&quot; GHz  (mu m)^&quot;</span><span class="p">,</span><span class="n">exponent</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    
        <span class="c1"># coupling = [1,1] dipole-dipole, [2,1]  quadrupole dipole, [2,2] quadrupole quadrupole</span>

        <span class="n">couplingMatArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">couplingMatConstructor</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> \
                                <span class="p">(</span><span class="n">couplingMatConstructor</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">couplingMatConstructor</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])),</span>\
                                       <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">dimension</span><span class="p">))</span>\
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">couplingMatConstructor</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">states</span><span class="p">,</span> <span class="n">couplingMatArray</span>
    
    
    <span class="k">def</span> <span class="nf">__initializeDatabaseForMemoization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># memoization of angular parts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFolder</span><span class="p">,</span>\
                                                 <span class="s2">&quot;precalculated_pair.db&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        
        <span class="c1">### ANGULAR PARTS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;DROP TABLE IF EXISTS pair_angularMatrix&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;SELECT COUNT(*) FROM sqlite_master </span>
<span class="s1">                            WHERE type=&#39;table&#39; AND name=&#39;pair_angularMatrix&#39;;&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># create table</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE IF NOT EXISTS pair_angularMatrix</span>
<span class="s1">                 (l1 TINYINT UNSIGNED, j1_x2 TINYINT UNSIGNED, </span>
<span class="s1">                 l2 TINYINT UNSIGNED, j2_x2 TINYINT UNSIGNED, </span>
<span class="s1">                 l3 TINYINT UNSIGNED, j3_x2 TINYINT UNSIGNED, </span>
<span class="s1">                 l4 TINYINT UNSIGNED, j4_x2 TINYINT UNSIGNED, </span>
<span class="s1">                 ind INTEGER,</span>
<span class="s1">                 PRIMARY KEY (l1,j1_x2, l2,j2_x2, l3,j3_x2, l4,j4_x2)</span>
<span class="s1">                ) &#39;&#39;&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__loadAngularMatrixElementsFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedAngularMatrixChanged</span> <span class="o">=</span> <span class="kc">False</span>
    
<div class="viewcode-block" id="PairStateInteractions.getLeRoyRadius"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions.getLeRoyRadius">[docs]</a>    <span class="k">def</span> <span class="nf">getLeRoyRadius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns Le Roy radius for initial pair-state.</span>
<span class="sd">            </span>
<span class="sd">            Le Roy radius [#leroy]_ is defined as </span>
<span class="sd">            :math:`2(\\langle r_1^2 \\rangle^{1/2} + \\langle r_2^2 \\rangle^{1/2})`,</span>
<span class="sd">            where :math:`r_1` and :math:`r_2` are electron coordinates for the</span>
<span class="sd">            first and the second atom in the initial pair-state.</span>
<span class="sd">            Below this radius, calculations are not valid since electron</span>
<span class="sd">            wavefunctions start to overlap.</span>
<span class="sd">            </span>
<span class="sd">            Returns:</span>
<span class="sd">                float: LeRoy radius measured in :math:`\\mu m`</span>
<span class="sd">                </span>
<span class="sd">            References:</span>
<span class="sd">                .. [#leroy] R.J. Le Roy, Can. J. Phys. **52**, 246 (1974)</span>
<span class="sd">                    http://www.nrcresearchpress.com/doi/abs/10.1139/p74-035</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.01</span>    
        <span class="n">a1</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">start1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">radialWavefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span>\
                                               <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">getEnergy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="mf">27.211</span><span class="p">,</span>\
                                               <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">alphaC</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.0</span><span class="p">),</span>\
                                               <span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">+</span><span class="mf">15.0</span><span class="p">),</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">upTo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span><span class="p">[</span><span class="n">start1</span><span class="p">:</span><span class="n">upTo</span><span class="p">]</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="n">b1</span><span class="p">[</span><span class="n">start1</span><span class="p">:</span><span class="n">upTo</span><span class="p">]</span>

        <span class="n">r1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">b1</span><span class="p">),</span>\
                                               <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a1</span><span class="p">)</span><span class="o">*</span><span class="n">step</span><span class="p">)))</span>
        
        <span class="n">a2</span><span class="p">,</span><span class="n">b2</span><span class="p">,</span><span class="n">start2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">radialWavefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">jj</span><span class="p">,</span>\
                                               <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">getEnergy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jj</span><span class="p">)</span><span class="o">/</span><span class="mf">27.211</span><span class="p">,</span>\
                                               <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">alphaC</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.0</span><span class="p">),</span>\
                                               <span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">+</span><span class="mf">15.0</span><span class="p">),</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">upTo2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">a2</span><span class="p">[</span><span class="n">start2</span><span class="p">:</span><span class="n">upTo2</span><span class="p">]</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">b2</span><span class="p">[</span><span class="n">start2</span><span class="p">:</span><span class="n">upTo2</span><span class="p">]</span>

        <span class="n">r2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span><span class="n">b2</span><span class="p">),</span>\
                                               <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span><span class="o">*</span><span class="n">step</span><span class="p">)))</span>
    
        
        <span class="k">return</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">r1</span><span class="o">+</span><span class="n">r2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">physical_constants</span><span class="p">[</span><span class="s2">&quot;Bohr radius&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.e6</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PairStateInteractions.getC6pertubatively"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions.getC6pertubatively">[docs]</a>    <span class="k">def</span> <span class="nf">getC6pertubatively</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">nRange</span><span class="p">,</span><span class="n">energyDelta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculates :math:`C_6` from second order pertubation theory.</span>
<span class="sd">            </span>
<span class="sd">            This calculation is faster then full diagonalization, but it is valid</span>
<span class="sd">            only far from the so called spaghetti region that occurs when atoms</span>
<span class="sd">            are close to each other. In that region multiple levels are strongly</span>
<span class="sd">            coupled, and one needs to use full diagonalization.</span>
<span class="sd">        </span>
<span class="sd">            See `pertubative C6 calculations example snippet`_.</span>
<span class="sd">            </span>
<span class="sd">            .. _`pertubative C6 calculations example snippet`:</span>
<span class="sd">                ./Rydberg_atoms_a_primer.html#Dispersion-Coefficients</span>
<span class="sd">        </span>
<span class="sd">            Args:</span>
<span class="sd">                theta (float): orientation of inter-atomic axis with respect</span>
<span class="sd">                    to quantization axis (:math:`z`) in Euler coordinates</span>
<span class="sd">                    (measured in units of radian)</span>
<span class="sd">                phi (float): orientation of inter-atomic axis with respect</span>
<span class="sd">                    to quantization axis (:math:`z`) in Euler coordinates </span>
<span class="sd">                    (measured in units of radian) </span>
<span class="sd">                nRange (int): how much below and above the given principal quantum number</span>
<span class="sd">                    of the pair state we should be looking</span>
<span class="sd">                energyDelta (float): what is maximum energy difference ( :math:`\\Delta E/h` in Hz)</span>
<span class="sd">                    between the original pair state and the other pair states that we are including in</span>
<span class="sd">                    calculation</span>
<span class="sd">            </span>
<span class="sd">            Returns:</span>
<span class="sd">                float: :math:`C_6` measured in :math:`\\text{GHz }\\mu\\text{m}^6`</span>
<span class="sd">            </span>
<span class="sd">            Example:</span>
<span class="sd">                If we want to quickly calculate :math:`C_6` for two Rubidium </span>
<span class="sd">                atoms in state :math:`62 D_{3/2} m_j=3/2`, positioned in space</span>
<span class="sd">                along the shared quantization axis::</span>
<span class="sd">                </span>
<span class="sd">                    from arc import *</span>
<span class="sd">                    calculation = PairStateInteractions(Rubidium(), 62, 2, 1.5, 62, 2, 1.5, 1.5, 1.5)</span>
<span class="sd">                    c6 = calculation.getC6pertubatively(0,0, 5, 25e9)</span>
<span class="sd">                    print &quot;C_6 = %.0f GHz (mu m)^6&quot; % c6</span>
<span class="sd">                    </span>
<span class="sd">                Which returns::</span>
<span class="sd">                </span>
<span class="sd">                    C_6 = 767 GHz (mu m)^6</span>
<span class="sd">                    </span>
<span class="sd">                Quick calculation of angular anisotropy of for Rubidium </span>
<span class="sd">                :math:`D_{2/5},m_j=5/2` states::</span>
<span class="sd">                </span>
<span class="sd">                    # Rb 60 D_{2/5}, mj=2.5 , 60 D_{2/5}, mj=2.5 pair state </span>
<span class="sd">                    calculation1 = PairStateInteractions(Rubidium(), 60, 2, 2.5, 60, 2, 2.5, 2.5, 2.5)</span>
<span class="sd">                    # list of atom orientations</span>
<span class="sd">                    thetaList = np.linspace(0,pi,30)</span>
<span class="sd">                    # do calculation of C6 pertubatively for all atom orientations</span>
<span class="sd">                    c6 = []</span>
<span class="sd">                    for theta in thetaList:</span>
<span class="sd">                        value = calculation1.getC6pertubatively(theta,0,5,25e9)</span>
<span class="sd">                        c6.append(value)</span>
<span class="sd">                        print (&quot;theta = %.2f * pi \tC6 = %.2f GHz  mum^6&quot; % (theta/pi,value))</span>
<span class="sd">                    # plot results</span>
<span class="sd">                    plot(thetaList/pi,c6,&quot;b-&quot;)</span>
<span class="sd">                    title(&quot;Rb, pairstate  60 $D_{5/2},m_j = 5/2$, 60 $D_{5/2},m_j = 5/2$&quot;)</span>
<span class="sd">                    xlabel(r&quot;$\Theta /\pi$&quot;)</span>
<span class="sd">                    ylabel(r&quot;$C_6$ (GHz $\mu$m${}^6$&quot;)</span>
<span class="sd">                    show()</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initializeDatabaseForMemoization</span><span class="p">()</span>

        <span class="c1"># ========= START OF THE MAIN CODE ===========</span>
        <span class="n">C6</span> <span class="o">=</span> <span class="mf">0.</span>
        
        <span class="c1"># wigner D matrix allows calculations with arbitrary orientation of</span>
        <span class="c1"># the two atoms</span>
        <span class="n">wgd</span> <span class="o">=</span> <span class="n">wignerDmatrix</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">phi</span><span class="p">)</span>
        <span class="c1"># state that we are coupling</span>
        <span class="n">statePart1</span> <span class="o">=</span> <span class="n">singleAtomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m1</span><span class="p">)</span>
        <span class="n">statePart2</span> <span class="o">=</span> <span class="n">singleAtomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">)</span>
        <span class="c1"># rotate individual states</span>
        <span class="n">dMatrix</span> <span class="o">=</span> <span class="n">wgd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">)</span> 
        <span class="n">statePart1</span> <span class="o">=</span> <span class="n">dMatrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">statePart1</span><span class="p">)</span>
        
        <span class="n">dMatrix</span> <span class="o">=</span> <span class="n">wgd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jj</span><span class="p">)</span>
        <span class="n">statePart2</span> <span class="o">=</span> <span class="n">dMatrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">statePart2</span><span class="p">)</span>
        <span class="n">stateCom</span> <span class="o">=</span> <span class="n">compositeState</span><span class="p">(</span><span class="n">statePart1</span><span class="p">,</span> <span class="n">statePart2</span><span class="p">)</span>
        
        <span class="c1"># any conservation?</span>
        <span class="n">limitBasisToMj</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">theta</span><span class="o">&lt;</span><span class="mf">0.001</span><span class="p">:</span>
            <span class="n">limitBasisToMj</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Mj will be conserved in calculations</span>
        <span class="n">originalMj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span>
        <span class="c1"># this numbers are conserved if we use only dipole-dipole interactions</span>
        <span class="n">Lmod2</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># find nearby states</span>
        
        <span class="n">lmin1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">lmin1</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">:</span>
            <span class="n">lmin1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lmin2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">lmin2</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">:</span>
            <span class="n">lmin2</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">for</span> <span class="n">n1</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">-</span><span class="n">nRange</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">+</span><span class="n">nRange</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">n2</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">-</span><span class="n">nRange</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">+</span><span class="n">nRange</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">l1</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">lmin1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">l2</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">lmin2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                        <span class="c1">#print n1,&quot; &quot;,n2,&quot; --- &quot;,l1,&quot; &quot;,l2</span>
                        <span class="n">j1</span> <span class="o">=</span> <span class="n">l1</span><span class="o">-</span><span class="mf">0.5</span>
                        <span class="k">if</span> <span class="n">l1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">j1</span> <span class="o">=</span> <span class="mf">0.5</span>
                        <span class="k">while</span> <span class="n">j1</span> <span class="o">&lt;=</span> <span class="n">l1</span><span class="o">+</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.1</span><span class="p">:</span>
                            <span class="n">j2</span> <span class="o">=</span> <span class="n">l2</span><span class="o">-</span><span class="mf">0.5</span>
                            <span class="k">if</span> <span class="n">l2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">j2</span> <span class="o">=</span> <span class="mf">0.5</span>
                            
                            <span class="k">while</span> <span class="n">j2</span> <span class="o">&lt;=</span> <span class="n">l2</span><span class="o">+</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.1</span><span class="p">:</span>
                                <span class="n">getEnergyDefect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">getEnergyDefect2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span>\
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">jj</span><span class="p">,</span>\
                                                                  <span class="n">n1</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span>\
                                                                  <span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">)</span><span class="o">/</span><span class="n">h</span>
                                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">getEnergyDefect</span><span class="p">)</span><span class="o">&lt;</span><span class="n">energyDelta</span>  \
                                    <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span>\
                                         <span class="p">(</span><span class="n">Lmod2</span> <span class="o">==</span> <span class="p">((</span><span class="n">l1</span><span class="o">+</span><span class="n">l2</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="p">))</span> <span class="p">:</span> 
                                    <span class="n">getEnergyDefect</span> <span class="o">=</span> <span class="n">getEnergyDefect</span><span class="o">*</span><span class="mf">1.0e-9</span> <span class="c1"># GHz</span>
                                    
                                    <span class="c1"># calculate radial part</span>
                                    <span class="n">couplingStregth</span> <span class="o">=</span> <span class="n">_atomLightAtomCoupling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">jj</span><span class="p">,</span>
                                            <span class="n">n1</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span>
                                            <span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0e-9</span><span class="o">*</span><span class="p">(</span><span class="mf">1.e6</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="n">h</span><span class="p">)</span> <span class="c1"># GHz / mum^3</span>
                                    <span class="c1">#print &quot;cs = &quot;,couplingStregth</span>
                                    
                                    <span class="n">pairState2</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">+</span><span class="n">printStateString</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">)</span><span class="o">+</span>\
                                        <span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="n">printStateString</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&gt;&quot;</span>
                                    <span class="c1">#print &quot;---&gt; &quot;+pairState2</span>
                                    
                                    <span class="c1"># include relevant mj and add contributions</span>
                                    <span class="k">for</span> <span class="n">m1c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span><span class="o">-</span><span class="n">j1</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">j1</span><span class="p">)):</span>
                                        <span class="k">for</span> <span class="n">m2c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">j2</span><span class="p">,</span><span class="o">-</span><span class="n">j2</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">j2</span><span class="p">)):</span>
                                            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">limitBasisToMj</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">originalMj</span><span class="o">-</span><span class="n">m1c</span><span class="o">-</span><span class="n">m2c</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">):</span>
                                                <span class="c1"># find angular part</span>
                                                <span class="n">statePart1</span> <span class="o">=</span> <span class="n">singleAtomState</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">m1c</span><span class="p">)</span>
                                                <span class="n">statePart2</span> <span class="o">=</span> <span class="n">singleAtomState</span><span class="p">(</span><span class="n">j2</span><span class="p">,</span> <span class="n">m2c</span><span class="p">)</span>
                                                <span class="c1"># rotate individual states</span>
                                                <span class="n">dMatrix</span> <span class="o">=</span> <span class="n">wgd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j1</span><span class="p">)</span>
                                                <span class="n">statePart1</span> <span class="o">=</span> <span class="n">dMatrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">statePart1</span><span class="p">)</span>
                                                <span class="n">dMatrix</span> <span class="o">=</span> <span class="n">wgd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j2</span><span class="p">)</span> 
                                                <span class="n">statePart2</span> <span class="o">=</span> <span class="n">dMatrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">statePart2</span><span class="p">)</span>
                                                <span class="c1"># composite state of two atoms</span>
                                                <span class="n">stateCom2</span> <span class="o">=</span> <span class="n">compositeState</span><span class="p">(</span><span class="n">statePart1</span><span class="p">,</span> <span class="n">statePart2</span><span class="p">)</span>
                                                
                                                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getAngularMatrix_M</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">jj</span><span class="p">,</span>
                                                                               <span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span>
                                                                               <span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span>
                                                
                                                <span class="n">angularFactor</span> <span class="o">=</span> <span class="n">conjugate</span><span class="p">(</span><span class="n">stateCom2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stateCom</span><span class="p">))</span>
                                                <span class="n">angularFactor</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">angularFactor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                                                
                                                <span class="c1">#print (&quot;%.5f&quot; % angularFactor)</span>
                                                
                                                <span class="n">C6</span> <span class="o">+=</span> <span class="p">((</span><span class="n">couplingStregth</span><span class="o">*</span><span class="n">angularFactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">getEnergyDefect</span><span class="p">)</span>
                                                
                                <span class="n">j2</span> <span class="o">=</span> <span class="n">j2</span><span class="o">+</span><span class="mf">1.0</span>
                            <span class="n">j1</span> <span class="o">=</span> <span class="n">j1</span><span class="o">+</span><span class="mf">1.0</span>

        
        <span class="c1"># ========= END OF THE MAIN CODE =========== </span>

        <span class="k">return</span> <span class="n">C6</span></div>
    
    
<div class="viewcode-block" id="PairStateInteractions.defineBasis"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions.defineBasis">[docs]</a>    <span class="k">def</span> <span class="nf">defineBasis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">nRange</span><span class="p">,</span><span class="n">lrange</span><span class="p">,</span><span class="n">energyDelta</span><span class="p">,</span>\
                         <span class="n">progressOutput</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">debugOutput</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Finds relevant states in the vicinity of the given pair-state</span>
<span class="sd">            </span>
<span class="sd">            Finds relevant pair-state basis and calculates interaction matrix.</span>
<span class="sd">            Pair-state basis is saved in `states`.</span>
<span class="sd">            Interaction matrix is saved in parts depending on the scaling with</span>
<span class="sd">            distance in :obj:`matDiagonal`, :obj:`matR3`, :obj:`matR4`,</span>
<span class="sd">            :obj:`matR5`. </span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                theta (float): relative orientation of the two atoms (ADD FIGURE)</span>
<span class="sd">                phi (float): relative orientation of the two atoms (ADD FIGURE)</span>
<span class="sd">                nRange (int): how much below and above the given principal quantum number</span>
<span class="sd">                    of the pair state we should be looking? (CORRECT THIS FOR TWO DIFFERNET STATES)</span>
<span class="sd">                lrange (int): what is the maximum angular orbital momentum state that we are including</span>
<span class="sd">                    in calculation</span>
<span class="sd">                energyDelta (float): what is maximum energy difference ( :math:`\\Delta E/h` in Hz)</span>
<span class="sd">                    between the original pair state and the other pair states that we are including in</span>
<span class="sd">                    calculation</span>
<span class="sd">                progressOutput (bool): optional, False by default. If true, prints</span>
<span class="sd">                    information about the progress of the calculation.</span>
<span class="sd">                debugOutput (bool): optional, False by default. If true, similar</span>
<span class="sd">                    to progressOutput=True, this will print information about the</span>
<span class="sd">                    progress of calculations, but with more verbose output.</span>
<span class="sd">            </span>
<span class="sd">            See also:</span>
<span class="sd">                :obj:`alkali_atom_functions.saveCalculation` and</span>
<span class="sd">                :obj:`alkali_atom_functions.loadSavedCalculation` for information</span>
<span class="sd">                on saving intermediate results of calculation for later use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__initializeDatabaseForMemoization</span><span class="p">()</span>
        
        <span class="c1"># save call parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRange</span> <span class="o">=</span> <span class="n">nRange</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrange</span> <span class="o">=</span> <span class="n">lrange</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">energyDelta</span> <span class="o">=</span> <span class="n">energyDelta</span>
        
        <span class="c1"># wignerDmatrix</span>
        <span class="n">wgd</span> <span class="o">=</span> <span class="n">wignerDmatrix</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">phi</span><span class="p">)</span>
        
        <span class="n">limitBasisToMj</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">theta</span><span class="o">&lt;</span><span class="mf">0.001</span><span class="p">):</span>
            <span class="n">limitBasisToMj</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Mj will be conserved in calculations</span>
            
        <span class="n">originalMj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__makeRawMatrix2</span><span class="p">(</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">jj</span><span class="p">,</span>
                                                    <span class="n">nRange</span><span class="p">,</span><span class="n">lrange</span><span class="p">,</span><span class="n">energyDelta</span><span class="p">,</span>
                                                    <span class="n">limitBasisToMj</span><span class="p">,</span>
                                                    <span class="n">progressOutput</span><span class="o">=</span><span class="n">progressOutput</span><span class="p">,</span>
                                                    <span class="n">debugOutput</span><span class="o">=</span><span class="n">debugOutput</span><span class="p">)</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">updateDipoleMatrixElementsFile</span><span class="p">()</span>
        <span class="c1">#print self.coupling[0]</span>
        <span class="c1">#print self.channel[0]</span>
        <span class="c1">#exit()</span>
        <span class="c1"># generate all the states (with mj principal quantum number)</span>
        
        <span class="c1"># opi = original pairstate index</span>
        <span class="n">opi</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># NEW FOR SPACE MATRIX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
            
            <span class="n">stateCoupled</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">m1c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="o">-</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>\
                                   <span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
                <span class="k">for</span> <span class="n">m2c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="o">-</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>\
                                       <span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">5</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">limitBasisToMj</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">originalMj</span><span class="o">-</span><span class="n">m1c</span><span class="o">-</span><span class="n">m2c</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">m1c</span><span class="p">,</span>
                                        <span class="n">stateCoupled</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">m2c</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">matrixElement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>   
                    
                        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                            <span class="nb">abs</span><span class="p">(</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                            <span class="nb">abs</span><span class="p">(</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                            <span class="nb">abs</span><span class="p">(</span><span class="n">m1c</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">m1</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                            <span class="nb">abs</span><span class="p">(</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                            <span class="nb">abs</span><span class="p">(</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                            <span class="nb">abs</span><span class="p">(</span><span class="n">stateCoupled</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">jj</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                            <span class="nb">abs</span><span class="p">(</span><span class="n">m2c</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="p">):</span>
                            <span class="n">opi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)):</span>
                <span class="nb">print</span> <span class="n">stateCoupled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
                           
        <span class="c1">#print self.states</span>
        <span class="c1">#print &quot;Original state = &quot;</span>
        <span class="c1">#print self.states[opi]</span>
        
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating Hamiltonian matrix...</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="n">dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">matrix (dimension &quot;</span><span class="p">,</span><span class="n">dimension</span><span class="p">,</span><span class="s2">&quot;)</span><span class="se">\n</span><span class="s2">&quot;</span>
    
        <span class="c1"># INITIALIZING MATICES</span>
        <span class="c1"># all (sparce) matrices will be saved in csr format</span>
        <span class="c1"># value, row, column</span>
        <span class="n">matDiagonalConstructor</span> <span class="o">=</span> <span class="p">[[],[],[]]</span>
        
        <span class="n">matRConstructor</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[[],[],[]]</span> \
                           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span>
        
        <span class="n">matRIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">progressOutput</span><span class="p">:</span>
                    <span class="n">dim</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
                    <span class="n">progress</span> <span class="o">+=</span> <span class="p">((</span><span class="n">dim</span><span class="o">-</span><span class="n">ii</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Matrix R</span><span class="si">%d</span><span class="s2"> </span><span class="si">%.1f</span><span class="s2"> </span><span class="si">%%</span><span class="s2"> (state </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span>\
                                      <span class="p">(</span><span class="n">matRIndex</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">dim</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">100.</span><span class="p">,</span>\
                                                   <span class="n">ii</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">)))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="c1">#print (&quot;%.1f %% (state %d of %d)&quot;%(float(ii)/len(self.channel)*100.,\</span>
                <span class="c1">#                                   ii,len(self.channel)))</span>
                <span class="n">ed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span>
                <span class="c1">#print ed</span>
                <span class="c1">#print self.index[ii],&quot; - &quot;,self.index[ii+1]</span>
                
                <span class="c1"># solves problems with exactly degenerate states</span>
                <span class="n">degeneracyOffset</span> <span class="o">=</span> <span class="mf">0.000001</span>
                
                <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">dMatrix1</span> <span class="o">=</span> <span class="n">wgd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dMatrix2</span> <span class="o">=</span> <span class="n">wgd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">])</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1">#print &quot;i=&quot;,i</span>
                    <span class="n">statePart1</span> <span class="o">=</span> <span class="n">singleAtomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">statePart2</span> <span class="o">=</span> <span class="n">singleAtomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">7</span><span class="p">])</span>
                    <span class="c1"># rotate individual states</span>
                     
                    <span class="n">statePart1</span> <span class="o">=</span> <span class="n">dMatrix1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">statePart1</span><span class="p">)</span>          
                    <span class="n">statePart2</span> <span class="o">=</span> <span class="n">dMatrix2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">statePart2</span><span class="p">)</span>
                    
                    <span class="n">stateCom</span> <span class="o">=</span> <span class="n">compositeState</span><span class="p">(</span><span class="n">statePart1</span><span class="p">,</span> <span class="n">statePart2</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="p">(</span><span class="n">matRIndex</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                        <span class="n">matDiagonalConstructor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ed</span><span class="o">+</span><span class="n">degeneracyOffset</span><span class="p">)</span>
                        <span class="n">degeneracyOffset</span> <span class="o">+=</span>  <span class="mf">0.000001</span>
                        <span class="n">matDiagonalConstructor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">matDiagonalConstructor</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    
                    <span class="k">for</span> <span class="n">dataIndex</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">c</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="c1">#print ii, c.indices[dataIndex], c.data[dataIndex]</span>
                        
                        <span class="n">jj</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">dataIndex</span><span class="p">]</span>
                        <span class="n">radialPart</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">dataIndex</span><span class="p">]</span>
                        
                        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                        <span class="n">dMatrix3</span> <span class="o">=</span> <span class="n">wgd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">dMatrix4</span> <span class="o">=</span> <span class="n">wgd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">6</span><span class="p">])</span> 
                        
                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getAngularMatrix_M</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span>
                            <span class="n">secondPart</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stateCom</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s2">&quot; - - - &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                        
                        
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">jj</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">statePart1</span> <span class="o">=</span> <span class="n">singleAtomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                            <span class="n">statePart2</span> <span class="o">=</span> <span class="n">singleAtomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">7</span><span class="p">])</span>
                            <span class="c1"># rotate individual states</span>
                            
                            <span class="n">statePart1</span> <span class="o">=</span> <span class="n">dMatrix3</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">statePart1</span><span class="p">)</span>
                            <span class="n">statePart2</span> <span class="o">=</span> <span class="n">dMatrix4</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">statePart2</span><span class="p">)</span>
                            <span class="c1"># composite state of two atoms</span>
                            <span class="n">stateCom2</span> <span class="o">=</span> <span class="n">compositeState</span><span class="p">(</span><span class="n">statePart1</span><span class="p">,</span> <span class="n">statePart2</span><span class="p">)</span>
                            
                            <span class="n">angularFactor</span> <span class="o">=</span> <span class="n">conjugate</span><span class="p">(</span><span class="n">stateCom2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">secondPart</span><span class="p">)</span>
                            <span class="n">angularFactor</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">angularFactor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

                            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">angularFactor</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1.e-5</span><span class="p">):</span>
                                <span class="n">matRConstructor</span><span class="p">[</span><span class="n">matRIndex</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radialPart</span><span class="o">*</span><span class="n">angularFactor</span><span class="p">)</span>
                                <span class="n">matRConstructor</span><span class="p">[</span><span class="n">matRIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                <span class="n">matRConstructor</span><span class="p">[</span><span class="n">matRIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                                    
                                <span class="n">matRConstructor</span><span class="p">[</span><span class="n">matRIndex</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radialPart</span><span class="o">*</span><span class="n">angularFactor</span><span class="p">)</span>
                                <span class="n">matRConstructor</span><span class="p">[</span><span class="n">matRIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                                <span class="n">matRConstructor</span><span class="p">[</span><span class="n">matRIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">matRIndex</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>               
        
        <span class="bp">self</span><span class="o">.</span><span class="n">matDiagonal</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">matDiagonalConstructor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                                    <span class="p">(</span><span class="n">matDiagonalConstructor</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">matDiagonalConstructor</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
                                       <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">dimension</span><span class="p">))</span>

        
        <span class="bp">self</span><span class="o">.</span><span class="n">matR</span> <span class="o">=</span> <span class="p">[</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">matRConstructor</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> \
                                 <span class="p">(</span><span class="n">matRConstructor</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">matRConstructor</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])),</span>
                                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">dimension</span><span class="p">))</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                     <span class="p">]</span>
        
                
        <span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span> <span class="o">=</span> <span class="n">opi</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__updateAngularMatrixElementsFile</span><span class="p">()</span></div>
        

            
<div class="viewcode-block" id="PairStateInteractions.diagonalise"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions.diagonalise">[docs]</a>    <span class="k">def</span> <span class="nf">diagonalise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rangeR</span><span class="p">,</span><span class="n">noOfEigenvectors</span><span class="p">,</span>
                         <span class="n">drivingFromState</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">progressOutput</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>\
                         <span class="n">debugOutput</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Finds eigenstates in atom pair basis.</span>
<span class="sd">            </span>
<span class="sd">            ARPACK ( :obj:`scipy.sparse.linalg.eigsh`) calculation of the </span>
<span class="sd">            `noOfEigenvectors` eigenvectors closest to the original state. If</span>
<span class="sd">            `drivingFromState` is specified as `[n,l,j,mj,q]` coupling between</span>
<span class="sd">            the pair-states and the situation where one of the atoms in the pair</span>
<span class="sd">            state basis is in :math:`|n,l,j,m_j\\rangle` state due to driving </span>
<span class="sd">            with a laser field that has polarization :math:`q` (+1,0,-1 for </span>
<span class="sd">            :math:`\\sigma^-`, :math:`\pi` and :math:`\\sigma^+` polarizations</span>
<span class="sd">            respectively)  is calculated and marked by the colurmaping these </span>
<span class="sd">            values on the obtained eigenvectors.</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                rangeR ( :obj:`array`): Array of values for distance between the</span>
<span class="sd">                    atoms (in :math:`\mu` m) for which we want to calculate </span>
<span class="sd">                    eigenstates.</span>
<span class="sd">                noOfEigenvectors (int): number of eigen vectors closest to the </span>
<span class="sd">                    energy of the original (unperturbed) pair state. Has to be</span>
<span class="sd">                    smaller then the total number of states.</span>
<span class="sd">                drivingFromState ([int,int,float,float,int]): Optional. State</span>
<span class="sd">                    of the one of the atoms from the original pair-state basis</span>
<span class="sd">                    from which we try to dribe to the excited pair-basis </span>
<span class="sd">                    manifold. By default, program will calculate just </span>
<span class="sd">                    contribution of the original pair-state in the eigenstates</span>
<span class="sd">                    obtained by diagonalization, and will highlight it&#39;s </span>
<span class="sd">                    admixure by colour mapping the obtained eigenstates plot.</span>
<span class="sd">                progressOutput (bool): optional, False by default. If true, prints</span>
<span class="sd">                    information about the progress of the calculation.</span>
<span class="sd">                debugOutput (bool): optional, False by default. If true, similar</span>
<span class="sd">                    to progressOutput=True, this will print information about the</span>
<span class="sd">                    progress of calculations, but with more verbose output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">rangeR</span>
        <span class="n">dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">noOfEigenvectors</span> <span class="o">=</span> <span class="n">noOfEigenvectors</span>
        
        <span class="c1"># energy of the state - to be calculated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># how much original state is contained in this eigenvector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highlight</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># what are the dominant contributing states?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">noOfEigenvectors</span><span class="o">&gt;=</span><span class="n">dimension</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">noOfEigenvectors</span><span class="o">=</span><span class="n">dimension</span><span class="o">-</span><span class="mi">1</span>
            <span class="nb">print</span> <span class="s2">&quot;Warning: Requested number of eigenvectors &gt;=dimension-1</span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                 ARPACK can only find up to dimension-1 eigenvectors, where</span><span class="se">\</span>
<span class="s2">                dimension is matrix dimension.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="k">if</span> <span class="n">noOfEigenvectors</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span>
                    
        <span class="n">coupling</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxCoupling</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxCoupledStateIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">drivingFromState</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drivingFromState</span> <span class="o">=</span> <span class="n">drivingFromState</span>
            <span class="k">if</span> <span class="n">progressOutput</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;Finding coupling strengths&quot;</span>
            <span class="c1"># get first what was the state we are calculating coupling with</span>
            <span class="n">state1</span> <span class="o">=</span> <span class="n">drivingFromState</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">state1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">l1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">state1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">j1</span> <span class="o">=</span> <span class="n">state1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">m1</span> <span class="o">=</span> <span class="n">state1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">state1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            
            <span class="c1">##i=0</span>
            <span class="c1">##while i&lt;dimension:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">dimension</span><span class="p">):</span>
                <span class="n">thisCoupling</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="c1">#if progressOutput:</span>
                <span class="c1">#    sys.stdout.write(&quot;\r%d%%&quot; %  (i/float(dimension)*100.))</span>
                <span class="c1">#    sys.stdout.flush()</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">l1</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> \
                   <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                   <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span><span class="p">][</span><span class="mi">5</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                   <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span><span class="p">][</span><span class="mi">6</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                   <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span><span class="p">][</span><span class="mi">7</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="p">:</span>
                    <span class="n">state2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">n2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">state2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">l2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">state2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">j2</span> <span class="o">=</span> <span class="n">state2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">m2</span> <span class="o">=</span> <span class="n">state2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">debugOutput</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="n">n1</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="s2">&quot; q=&quot;</span><span class="p">,</span><span class="n">q</span>
                        <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">dme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">getDipoleMatrixElement</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span>\
                                                            <span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span>\
                                                            <span class="n">q</span><span class="p">)</span>
                    <span class="n">thisCoupling</span> <span class="o">+=</span> <span class="n">dme</span> 

                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">l1</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> \
                    <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span>\
                    <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                    <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="ow">and</span> \
                    <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.1</span> <span class="p">:</span>
                    <span class="n">state2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">n2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">state2</span><span class="p">[</span><span class="mi">0</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">l2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">state2</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">j2</span> <span class="o">=</span> <span class="n">state2</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">m2</span> <span class="o">=</span> <span class="n">state2</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">debugOutput</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="n">n1</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="s2">&quot; q=&quot;</span><span class="p">,</span><span class="n">q</span>
                        <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">dme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">getDipoleMatrixElement</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span>\
                                                            <span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span>\
                                                            <span class="n">q</span><span class="p">)</span>
                    <span class="n">thisCoupling</span> <span class="o">+=</span> <span class="n">dme</span>
                     
                <span class="n">thisCoupling</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">thisCoupling</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="k">if</span> <span class="n">thisCoupling</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxCoupling</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">maxCoupling</span> <span class="o">=</span> <span class="n">thisCoupling</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">maxCoupledStateIndex</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">thisCoupling</span> <span class="o">&gt;</span><span class="mf">0.000001</span><span class="p">)</span> <span class="ow">and</span> <span class="n">debugOutput</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;original pairstate index = &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span> 
                    <span class="nb">print</span> <span class="s2">&quot;this pairstate index = &quot;</span><span class="p">,</span><span class="n">i</span>
                    <span class="nb">print</span> <span class="s2">&quot;state itself &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="nb">print</span> <span class="s2">&quot;coupling = &quot;</span><span class="p">,</span><span class="n">thisCoupling</span>       
                <span class="n">coupling</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisCoupling</span><span class="p">)</span>
            
            <span class="nb">print</span> <span class="s2">&quot;Maximal coupling from a state&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;is to a state &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxCoupledStateIndex</span>
            <span class="nb">print</span> <span class="s2">&quot;is equal to </span><span class="si">%.3e</span><span class="s2"> a_0 e&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxCoupling</span>
            <span class="c1">#print &quot;Coupling strengths calculated for each pair-state&quot;</span>
            <span class="c1">#print coupling   </span>
        
        <span class="k">if</span> <span class="n">progressOutput</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Diagonalizing interaction matrix...</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="n">rvalIndex</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">rval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">progressOutput</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">%d%%</span><span class="s2">&quot;</span> <span class="o">%</span>  <span class="p">(</span><span class="n">rvalIndex</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="mf">100.</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">rvalIndex</span> <span class="o">+=</span> <span class="mf">1.</span>
            
            <span class="c1"># calculate interaction matrix</span>
            
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matDiagonal</span>
            
            <span class="n">rX</span> <span class="o">=</span> <span class="p">(</span><span class="n">rval</span><span class="o">*</span><span class="mf">1.e-6</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
            <span class="k">for</span> <span class="n">matRX</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">matR</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">matRX</span><span class="o">/</span><span class="n">rX</span>
                <span class="n">rX</span> <span class="o">*=</span> <span class="p">(</span><span class="n">rval</span><span class="o">*</span><span class="mf">1.e-6</span><span class="p">)</span> 
            
            <span class="c1"># uses ARPACK algorithm to find only X eigenvectors</span>
            <span class="n">ev</span><span class="p">,</span> <span class="n">egvector</span> <span class="o">=</span> <span class="n">eigsh</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">noOfEigenvectors</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;LM&#39;</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
            
        
            <span class="k">if</span> <span class="p">(</span><span class="n">drivingFromState</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">):</span>
                <span class="c1"># if we&#39;ve defined from which state we are driving</span>
                <span class="n">sh</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="p">)):</span>
                    <span class="n">sh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">egvector</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalPairStateIndex</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">comp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stateComposition</span><span class="p">(</span><span class="n">egvector</span><span class="p">[:,</span><span class="n">i</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sh</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="p">)):</span>
                    <span class="n">sumCoupledStates</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">dimension</span><span class="p">):</span>
                        <span class="n">sumCoupledStates</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">coupling</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">maxCoupling</span><span class="p">)</span><span class="o">*</span>\
                                                <span class="nb">abs</span><span class="p">(</span><span class="n">egvector</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">comp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stateComposition</span><span class="p">(</span><span class="n">egvector</span><span class="p">[:,</span><span class="n">i</span><span class="p">]))</span>           
                    <span class="n">sh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sumCoupledStates</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span></div>

        <span class="c1"># end of FOR loop over inter-atomic dinstaces</span>
    
    
<div class="viewcode-block" id="PairStateInteractions.exportData"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions.exportData">[docs]</a>    <span class="k">def</span> <span class="nf">exportData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileBase</span><span class="p">,</span><span class="n">exportFormat</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Exports PairStateInteractions calculation data.</span>
<span class="sd">            </span>
<span class="sd">            Only supported format (selected by default) is .csv in a </span>
<span class="sd">            human-readable form with a header that saves details of calculation. </span>
<span class="sd">            Function saves three files: 1) `filebase` _r.csv; </span>
<span class="sd">            2) `filebase` _energyLevels</span>
<span class="sd">            3) `filebase` _highlight</span>
<span class="sd">           </span>
<span class="sd">            For more details on the format, see header of the saved files.</span>
<span class="sd">           </span>
<span class="sd">            Args:</span>
<span class="sd">                filebase (string): filebase for the names of the saved files</span>
<span class="sd">                    without format extension. Add as a prefix a directory path</span>
<span class="sd">                    if necessary (e.g. saving outside the current working directory)</span>
<span class="sd">                exportFormat (string): optional. Format of the exported file. Currently</span>
<span class="sd">                    only .csv is supported but this can be extended in the future.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;on %Y-%m-</span><span class="si">%d</span><span class="s1"> @ %H:%M:%S&#39;</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        
        <span class="n">commonHeader</span> <span class="o">=</span> <span class="s2">&quot;Export from Alkali Rydberg Calculator (ARC) </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ts</span>
        <span class="n">commonHeader</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> *** Pair State interactions for </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> m_j = </span><span class="si">%d</span><span class="s2">/2 , </span><span class="si">%s</span><span class="s2"> m_j = </span><span class="si">%d</span><span class="s2">/2 pair-state. ***</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span>\
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">elementName</span><span class="p">,</span>
                        <span class="n">printStateString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">m1</span><span class="p">)),</span>\
                        <span class="n">printStateString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jj</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot; - Pair-state interactions included up to dipole-dipole coupling.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactionsUpTo</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot; - Pair-state interactions included up to quadrupole-quadrupole coupling.</span><span class="se">\n</span><span class="s2">&quot;</span>           

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">):</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot; - Atom orientation:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot;      theta (polar angle) = </span><span class="si">%.5f</span><span class="s2"> x pi</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">/</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot;      phi (azimuthal angle) = </span><span class="si">%.5f</span><span class="s2"> x pi</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="o">/</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot; - Calculation basis includes:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot;      States with principal quantum number in range [</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">]x[</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">],</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span>\
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nRange</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nRange</span><span class="p">,</span>\
                             <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nRange</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nRange</span><span class="p">)</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot;      AND whose orbital angular momentum (l) is in range [</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">] (i.e. </span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span>\
                            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lrange</span><span class="p">,</span><span class="n">printStateLetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">printStateLetter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrange</span><span class="p">))</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot;      AND whose pair-state energy difference is at most </span><span class="si">%.3f</span><span class="s2"> GHz</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>\
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energyDelta</span><span class="o">/</span><span class="mf">1.e9</span><span class="p">)</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot;      (energy difference is measured relative to original pair-state).</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot; ! Atom orientation and basis not yet set (this is set in defineBasis method).</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;noOfEigenvectors&quot;</span><span class="p">):</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot; - Finding </span><span class="si">%d</span><span class="s2"> eigenvectors closest to the given pair-state</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">noOfEigenvectors</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drivingFromState</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="p">:</span>
                <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot; - State highlighting based on the relative contribution </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
                <span class="s2">&quot;   of the original pair-state in the eigenstates obtained by diagonalization.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commonHeader</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot; - State highlighting based on the relative driving strength </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
                <span class="s2">&quot;   to a given energy eigenstate (energy level) from state</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
                <span class="s2">&quot;   </span><span class="si">%s</span><span class="s2"> m_j =</span><span class="si">%d</span><span class="s2">/2 with polarization q=</span><span class="si">%d</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span>\
                 <span class="p">(</span> <span class="n">printStateString</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">drivingFromState</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]),</span>\
                 <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">drivingFromState</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">drivingFromState</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot; ! Energy levels not yet found (this is done by calling diagonalise method).</span><span class="se">\n</span><span class="s2">&quot;</span>

                
        
        <span class="k">if</span> <span class="n">exportFormat</span><span class="o">==</span><span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Exporting StarkMap calculation results as .csv ...&quot;</span>
            
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="s2">&quot; - Export consists of three (3) files:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;       1) </span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileBase</span><span class="o">+</span><span class="s2">&quot;_r.&quot;</span><span class="o">+</span><span class="n">exportFormat</span><span class="p">))</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;       2) </span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileBase</span><span class="o">+</span><span class="s2">&quot;_energyLevels.&quot;</span><span class="o">+</span><span class="n">exportFormat</span><span class="p">))</span>
            <span class="n">commonHeader</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;       3) </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileBase</span><span class="o">+</span><span class="s2">&quot;_highlight.&quot;</span><span class="o">+</span><span class="n">exportFormat</span><span class="p">))</span>
            
            <span class="n">filename</span> <span class="o">=</span> <span class="n">fileBase</span><span class="o">+</span><span class="s2">&quot;_r.&quot;</span><span class="o">+</span><span class="n">exportFormat</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.18e</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">,</span>\
                <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> \
                <span class="n">header</span><span class="o">=</span><span class="p">(</span><span class="n">commonHeader</span> <span class="o">+</span> <span class="s2">&quot; - - - Interatomic distance, r (\mu m) - - -&quot;</span><span class="p">),</span>\
                <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;# &#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;   Interatomic distances (\mu m) saved in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span> 
            
            <span class="n">filename</span> <span class="o">=</span> <span class="n">fileBase</span><span class="o">+</span><span class="s2">&quot;_energyLevels.&quot;</span><span class="o">+</span><span class="n">exportFormat</span>
            <span class="n">headerDetails</span> <span class="o">=</span> <span class="s2">&quot; NOTE : Each row corresponds to eigenstates for a single specified interatomic distance&quot;</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.18e</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">,</span>\
                <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> \
                <span class="n">header</span><span class="o">=</span><span class="p">(</span><span class="n">commonHeader</span> <span class="o">+</span> <span class="s1">&#39; - - - Energy (GHz) - - -</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">headerDetails</span><span class="p">),</span>\
                <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;# &#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;   Lists of energies (in GHz relative to the original pair-state energy)&quot;</span><span class="o">+</span>\
                  <span class="p">(</span><span class="s2">&quot; saved in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            
            <span class="n">filename</span> <span class="o">=</span> <span class="n">fileBase</span><span class="o">+</span><span class="s2">&quot;_highlight.&quot;</span><span class="o">+</span><span class="n">exportFormat</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.18e</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">,</span>\
                <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> \
                <span class="n">header</span><span class="o">=</span><span class="p">(</span><span class="n">commonHeader</span> <span class="o">+</span> <span class="s1">&#39; - - - Highlight value (rel.units) - - -</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span> <span class="n">headerDetails</span><span class="p">),</span>\
                <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;# &#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;   Highlight values saved in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span>
            
            <span class="nb">print</span> <span class="s2">&quot;... data export finished!&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported export format (.</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="nb">format</span><span class="p">)</span></div>
        
    
    <span class="k">def</span> <span class="nf">_stateComposition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stateVector</span><span class="p">):</span>
        <span class="n">contribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">stateVector</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">contribution</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;heapsort&#39;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">totalContribution</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;$&quot;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">index</span><span class="o">&gt;-</span><span class="mi">5</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">totalContribution</span><span class="o">&lt;</span><span class="mf">0.95</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="o">!=-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">stateVector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">value</span><span class="o">+=</span> <span class="s2">&quot;+&quot;</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stateVector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_addState</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">totalContribution</span> <span class="o">+=</span> <span class="n">contribution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">index</span> <span class="o">-=</span> <span class="mi">1</span>
            
        <span class="k">if</span> <span class="n">totalContribution</span><span class="o">&lt;</span><span class="mf">0.999</span><span class="p">:</span>
            <span class="n">value</span><span class="o">+=</span><span class="s2">&quot;+</span><span class="se">\\</span><span class="s2">ldots&quot;</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">+</span><span class="s2">&quot;$&quot;</span>
    
    <span class="k">def</span> <span class="nf">_addState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">mj1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="n">mj2</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;|</span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">/2,</span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">/2</span><span class="se">\\</span><span class="s2">rangle&quot;</span> <span class="o">%</span>\
             <span class="p">(</span><span class="n">printStateStringLatex</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">j1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">mj1</span><span class="p">),</span>\
              <span class="n">printStateStringLatex</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">j2</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">mj2</span><span class="p">))</span>
    
<div class="viewcode-block" id="PairStateInteractions.plotLevelDiagram"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions.plotLevelDiagram">[docs]</a>    <span class="k">def</span> <span class="nf">plotLevelDiagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">highlightColor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Plots pair state level diagram</span>
<span class="sd">                        </span>
<span class="sd">            Call :obj:`showPlot` if you want to display a plot afterwards.</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                highlightColor (string): optional, specifies the colour used</span>
<span class="sd">                    for state highlighting</span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">rvb</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;mymap&#39;</span><span class="p">,</span>\
                                                 <span class="p">[</span><span class="s1">&#39;0.9&#39;</span><span class="p">,</span> <span class="n">highlightColor</span><span class="p">])</span>
        
        <span class="n">cNorm</span>  <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        
        <span class="nb">print</span> <span class="s2">&quot; Now we are plotting...&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.5</span><span class="p">,</span><span class="mf">5.0</span><span class="p">))</span> <span class="c1">#figsize=(15.5,7.0)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">)</span>
        
        
        <span class="n">colorfulX</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">colorfulY</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">colorfulState</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)):</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="n">colorfulX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">colorfulY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="n">colorfulState</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        
        <span class="n">colorfulState</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colorfulState</span><span class="p">)</span>
        <span class="n">sortOrder</span> <span class="o">=</span> <span class="n">colorfulState</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;heapsort&#39;</span><span class="p">)</span>
        <span class="n">colorfulX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colorfulX</span><span class="p">)</span>
        <span class="n">colorfulY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colorfulY</span><span class="p">)</span>
        
        <span class="n">colorfulX</span> <span class="o">=</span> <span class="n">colorfulX</span><span class="p">[</span><span class="n">sortOrder</span><span class="p">]</span>
        <span class="n">colorfulY</span> <span class="o">=</span> <span class="n">colorfulY</span><span class="p">[</span><span class="n">sortOrder</span><span class="p">]</span>
        <span class="n">colorfulState</span> <span class="o">=</span> <span class="n">colorfulState</span><span class="p">[</span><span class="n">sortOrder</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">colorfulX</span><span class="p">,</span><span class="n">colorfulY</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">colorfulState</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
                        <span class="n">norm</span><span class="o">=</span><span class="n">cNorm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">rvb</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">ColorbarBase</span><span class="p">(</span><span class="n">cax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">rvb</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">cNorm</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drivingFromState</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># colouring is based on the contribution of the original pair state here</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">r&quot;$|\langle </span><span class="si">%s</span><span class="s2"> m_j=</span><span class="si">%d</span><span class="s2">/2 , </span><span class="si">%s</span><span class="s2"> m_j=</span><span class="si">%d</span><span class="s2">/2 | \mu \rangle |^2$&quot;</span> <span class="o">%</span> \
                                 <span class="p">(</span><span class="n">printStateStringLatex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">),</span>\
                                  <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">m1</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span>\
                                  <span class="n">printStateStringLatex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">jj</span><span class="p">),</span>\
                                  <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># colouring is based on the coupling to different states</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">r&quot;$(\Omega_\mu/\Omega)^2$&quot;</span> <span class="p">)</span>
        
        <span class="c1">#self.ax.scatter(grayX,grayY,s=10,linewidth=0,color=&quot;0.9&quot;,zorder=1)</span>
        <span class="c1">#self.ax.scatter(colorfulX,colorfulY,s=10,c=colorfulState,linewidth=0,cmap=rvb,zorder=2)#mpl.cm.Blues)</span>
            
        
        <span class="c1">##for br in xrange(len(self.y[0])):</span>
        <span class="c1">##    sumStates = 0.0</span>
        <span class="c1">##    for br2 in xrange(len(self.y)):</span>
        <span class="c1">##        sumStates = sumStates+self.highlight[br2][br]</span>
        <span class="c1">##    print sumStates</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">r&quot;Interatomic distance, $R$ ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">r&quot;Pair-state relative energy, $\Delta E/h$ (GHz)&quot;</span><span class="p">)</span></div>
        <span class="c1">#self.ax.set_xscale(&quot;log&quot;, nonposy=&#39;clip&#39;)</span>
        <span class="c1">#self.ax.set_yscale(&quot;log&quot;, nonposy=&#39;clip&#39;)        </span>

<div class="viewcode-block" id="PairStateInteractions.savePlot"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions.savePlot">[docs]</a>    <span class="k">def</span> <span class="nf">savePlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;PairStateInteractions.pdf&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Saves plot made by :obj:`plotLevelDiagram`</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                filename (:obj:`str`, optional): file location where the plot </span>
<span class="sd">                    should be saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Error while saving a plot: nothing is plotted yet&quot;</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="PairStateInteractions.showPlot"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions.showPlot">[docs]</a>    <span class="k">def</span> <span class="nf">showPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interactive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Shows level diagram printed by </span>
<span class="sd">            :obj:`PairStateInteractions.plotLevelDiagram`</span>
<span class="sd">            </span>
<span class="sd">            By default, it will output interactive plot, which means that</span>
<span class="sd">            clicking on the state will show the composition of the clicked</span>
<span class="sd">            state in original basis (dominant elements)</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                interactive (bool): optional, by default it is True. If true,</span>
<span class="sd">                    plotted graph will be interactive, i.e. users can click</span>
<span class="sd">                    on the state to identify the state composition</span>
<span class="sd">                    </span>
<span class="sd">            Note:</span>
<span class="sd">                interactive=True has effect if the graphs are explored in usual</span>
<span class="sd">                matplotlib pop-up windows. It doesn&#39;t have effect on inline</span>
<span class="sd">                plots in Jupyter (IPython) notebooks.</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Click on state to see state composition&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clickedPoint</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;pick_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onPick</span><span class="p">)</span>
            
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">0</span></div>
    
    <span class="k">def</span> <span class="nf">_onPick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">PathCollection</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">mouseevent</span><span class="o">.</span><span class="n">xdata</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">mouseevent</span><span class="o">.</span><span class="n">ydata</span>
            
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">))):</span>
                <span class="n">i</span> <span class="o">-=</span><span class="mi">1</span>
            
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">)):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">jj</span>
            
            <span class="c1"># now choose the most higlighted state in this area        </span>
            <span class="n">distance</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">1.5</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">distance</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">])</span><span class="o">&gt;</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]))):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">jj</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clickedPoint</span><span class="o">!=</span><span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clickedPoint</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">clickedPoint</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]],</span><span class="s2">&quot;bs&quot;</span><span class="p">,</span>\
                                                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            
            
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;State = &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span>\
                              <span class="p">(</span><span class="s2">&quot;   Colourbar = </span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        
            <span class="n">event</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
      
<div class="viewcode-block" id="PairStateInteractions.getC6fromLevelDiagram"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions.getC6fromLevelDiagram">[docs]</a>    <span class="k">def</span> <span class="nf">getC6fromLevelDiagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rStart</span><span class="p">,</span><span class="n">rStop</span><span class="p">,</span><span class="n">showPlot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>\
                              <span class="n">minStateContribution</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Finds :math:`C_6` coefficient for original pair state.</span>
<span class="sd">            </span>
<span class="sd">            Function first finds for each distance in the range </span>
<span class="sd">            [ `rStart` , `rStop` ] the eigen state with highest contribution of </span>
<span class="sd">            the original state. One can set optional parameter </span>
<span class="sd">            `minStateContribution` to value in the range [0,1), so that function</span>
<span class="sd">            finds only states if they have contribution of the original state </span>
<span class="sd">            that is bigger then `minStateContribution`.</span>
<span class="sd">            </span>
<span class="sd">            Once original pair-state is found in the range of interatomic </span>
<span class="sd">            distances, from smallest `rStart` to the biggest `rStop`, function</span>
<span class="sd">            will try to perform fitting of the corresponding state energy </span>
<span class="sd">            :math:`E(R)` at distance :math:`R` to the function </span>
<span class="sd">            :math:`A+C_6/R^6` where :math:`A` is some offset. </span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                rStart (float): smallest inter-atomic distance to be used for fitting</span>
<span class="sd">                rStop (float): maximum inter-atomic distance to be used for fitting</span>
<span class="sd">                showPlot (bool): If set to true, it will print the plot showing</span>
<span class="sd">                    fitted energy level and the obtained best fit. Default is</span>
<span class="sd">                    False</span>
<span class="sd">                minStateContribution (float): valid values are in the range [0,1).</span>
<span class="sd">                    It specifies minimum amount of the original state in the given</span>
<span class="sd">                    energy state necessary for the state to be considered for</span>
<span class="sd">                    the adiabatic continuation of the original unperturbed </span>
<span class="sd">                    pair state.</span>
<span class="sd">                    </span>
<span class="sd">            Returns:</span>
<span class="sd">                float:</span>
<span class="sd">                    :math:`C_6` measured in :math:`\\text{GHz }\\mu\\text{m}^6`</span>
<span class="sd">                    on success; If unsuccessful returns False.</span>
<span class="sd">                    </span>
<span class="sd">            Note:</span>
<span class="sd">                In order to use this functions, highlighting in </span>
<span class="sd">                :obj:`diagonalise` should be based on the original pair </span>
<span class="sd">                state contribution of the eigenvectors (that this, </span>
<span class="sd">                `drivingFromState` parameter should not be set, which </span>
<span class="sd">                corresponds to `drivingFromState` = [0,0,0,0,0]).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">initialStateDetuning</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">initialStateDetuningX</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">fromRindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">toRindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fromRindex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">br</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">rStart</span><span class="p">):</span> 
                <span class="n">fromRindex</span> <span class="o">=</span> <span class="n">br</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">br</span><span class="p">]</span><span class="o">&gt;</span><span class="n">rStop</span><span class="p">):</span>
                <span class="n">toRindex</span> <span class="o">=</span> <span class="n">br</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fromRindex</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">toRindex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">toRindex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fromRindex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERROR: could not find data for energy levels for interatomic&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;distances between %2.f and </span><span class="si">%.2f</span><span class="s2"> mu m.</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rStart</span><span class="p">,</span><span class="n">rStop</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="c1"># print fromRindex,&quot; &quot;,toRindex</span>
        
        
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">fromRindex</span><span class="p">,</span><span class="n">toRindex</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">maxPortion</span> <span class="o">=</span> <span class="n">minStateContribution</span>
            <span class="k">for</span> <span class="n">br2</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">br</span><span class="p">])):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">br2</span><span class="p">])</span><span class="o">&gt;</span><span class="n">maxPortion</span><span class="p">):</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">br2</span>
                    <span class="n">maxPortion</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">br2</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">initialStateDetuning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">index</span><span class="p">]))</span>
                <span class="n">initialStateDetuningX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">br</span><span class="p">])</span>
        
        <span class="n">initialStateDetuning</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">))</span>
        <span class="n">initialStateDetuningX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">c6fit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c6</span><span class="p">,</span><span class="n">offset</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">c6</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">6</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">popt</span><span class="p">,</span><span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">c6fit</span><span class="p">,</span>\
                              <span class="n">initialStateDetuningX</span><span class="p">,</span>\
                              <span class="n">initialStateDetuning</span><span class="p">,</span>\
                              <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: unable to find a fit for C6.&quot;</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="nb">print</span> <span class="s2">&quot;c6 = &quot;</span><span class="p">,</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s2">&quot; GHz /R^6 (mu m)^6&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;offset = &quot;</span><span class="p">,</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">y_fit</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">initialStateDetuningX</span><span class="p">:</span>
            <span class="n">y_fit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c6fit</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">y_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_fit</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">showPlot</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">8.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">),</span>\
                      <span class="s2">&quot;b-&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_fit</span><span class="p">),</span>\
                      <span class="s2">&quot;r--&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1">#loglog(initialStateDetuningX[150:250],y_theory,&quot;k:&quot;)</span>
            <span class="c1">#xlim(0.9,10)</span>
            <span class="c1">#ylim(1e2,1e12)</span>
            <span class="c1">#ax.grid()</span>
            <span class="c1">#ax.grid(which=&#39;minor&#39;, color=&#39;0.5&#39;, linestyle=&#39;:&#39;)</span>
            
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s2">&quot;calculated energy level&quot;</span><span class="p">,</span><span class="s2">&quot;fitted model function&quot;</span><span class="p">),</span>\
                      <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">),</span>\
                        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">)</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span> <span class="n">exp</span><span class="p">(</span><span class="n">ymin</span><span class="p">),</span><span class="n">exp</span><span class="p">(</span><span class="n">ymax</span><span class="p">))</span>
            
            <span class="n">minorLocator</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">minorFormatter</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">minorLocator</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span><span class="n">minorFormatter</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">NullFormatter</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">r&quot;Interatomic distance, $r$ ($\mu$m)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">r&quot;Pair-state energy, $|E|$ (GHz)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">r&quot;$C_6$ fit&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fitX</span> <span class="o">=</span> <span class="n">initialStateDetuningX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitY</span> <span class="o">=</span> <span class="n">initialStateDetuning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fittedCurveY</span> <span class="o">=</span> <span class="n">y_fit</span>
        
        <span class="k">return</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="PairStateInteractions.getC3fromLevelDiagram"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions.getC3fromLevelDiagram">[docs]</a>    <span class="k">def</span> <span class="nf">getC3fromLevelDiagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rStart</span><span class="p">,</span><span class="n">rStop</span><span class="p">,</span><span class="n">showPlot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>\
                              <span class="n">minStateContribution</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>\
                              <span class="n">resonantBranch</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Finds :math:`C_3` coefficient for original pair state.</span>
<span class="sd">            </span>
<span class="sd">            Function first finds for each distance in the range </span>
<span class="sd">            [`rStart` , `rStop`] the eigen state with highest contribution of </span>
<span class="sd">            the original state. One can set optional parameter </span>
<span class="sd">            `minStateContribution` to value in the range [0,1), so that function</span>
<span class="sd">            finds only states if they have contribution of the original state </span>
<span class="sd">            that is bigger then `minStateContribution`.</span>
<span class="sd">            </span>
<span class="sd">            Once original pair-state is found in the range of interatomic </span>
<span class="sd">            distances, from smallest `rStart` to the biggest `rStop`, function</span>
<span class="sd">            will try to perform fitting of the corresponding state energy </span>
<span class="sd">            :math:`E(R)` at distance :math:`R` to the function </span>
<span class="sd">            :math:`A+C_3/R^3` where :math:`A` is some offset. </span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                rStart (float): smallest inter-atomic distance to be used for fitting</span>
<span class="sd">                rStop (float): maximum inter-atomic distance to be used for fitting</span>
<span class="sd">                showPlot (bool): If set to true, it will print the plot showing</span>
<span class="sd">                    fitted energy level and the obtained best fit. Default is</span>
<span class="sd">                    False</span>
<span class="sd">                minStateContribution (float): valid values are in the range [0,1).</span>
<span class="sd">                    It specifies minimum amount of the original state in the given</span>
<span class="sd">                    energy state necessary for the state to be considered for</span>
<span class="sd">                    the adiabatic continuation of the original unperturbed </span>
<span class="sd">                    pair state.</span>
<span class="sd">            Returns:</span>
<span class="sd">                float:</span>
<span class="sd">                    :math:`C_3` measured in :math:`\\text{GHz }\\mu\\text{m}^6`</span>
<span class="sd">                    on success; If unsuccessful returns False.</span>
<span class="sd">            </span>
<span class="sd">            Note:</span>
<span class="sd">                In order to use this functions, highlighting in </span>
<span class="sd">                :obj:`diagonalise` should be based on the original pair </span>
<span class="sd">                state contribution of the eigenvectors (that this, </span>
<span class="sd">                `drivingFromState` parameter should not be set, which </span>
<span class="sd">                corresponds to `drivingFromState` = [0,0,0,0,0]).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="c1"># for resonant interactions we have two branches with identical</span>
        <span class="c1"># state contributions. In this case, we will select only</span>
        <span class="c1"># positively detuned branch (for resonantBranch = +1)</span>
        <span class="c1"># or negatively detuned branch (fore resonantBranch = -1)</span>
        <span class="c1"># depending on the value of resonantBranch optional parameter</span>
        <span class="n">selectBranch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ll</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">selectBranch</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">resonantBranch</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">resonantBranch</span><span class="p">)</span>
        
        <span class="n">initialStateDetuning</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">initialStateDetuningX</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">fromRindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">toRindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fromRindex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">br</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">rStart</span><span class="p">):</span> 
                <span class="n">fromRindex</span> <span class="o">=</span> <span class="n">br</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">br</span><span class="p">]</span><span class="o">&gt;</span><span class="n">rStop</span><span class="p">):</span>
                <span class="n">toRindex</span> <span class="o">=</span> <span class="n">br</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fromRindex</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">toRindex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">toRindex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fromRindex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERROR: could not find data for energy levels for interatomic&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;distances between %2.f and </span><span class="si">%.2f</span><span class="s2"> mu m.</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rStart</span><span class="p">,</span><span class="n">rStop</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># print fromRindex,&quot; &quot;,toRindex</span>
        
        <span class="n">discontinuityDetected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">toRindex</span><span class="p">,</span><span class="n">fromRindex</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">maxPortion</span> <span class="o">=</span> <span class="n">minStateContribution</span>
            <span class="k">for</span> <span class="n">br2</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">br</span><span class="p">])):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">br2</span><span class="p">])</span><span class="o">&gt;</span><span class="n">maxPortion</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">selectBranch</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">br2</span><span class="p">]</span><span class="o">*</span><span class="n">selectBranch</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)):</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">br2</span>
                    <span class="n">maxPortion</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">br2</span><span class="p">])</span>
                    
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">slope1</span> <span class="o">=</span> <span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">initialStateDetuning</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span>\
                        <span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">initialStateDetuningX</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">slope2</span> <span class="o">=</span>  <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">index</span><span class="p">])</span><span class="o">-</span><span class="n">initialStateDetuning</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span>\
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">br</span><span class="p">]</span><span class="o">-</span><span class="n">initialStateDetuningX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slope2</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">3.</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">slope1</span><span class="p">):</span>
                    <span class="n">discontinuityDetected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">discontinuityDetected</span><span class="p">):</span>
                <span class="n">initialStateDetuning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">index</span><span class="p">]))</span>
                <span class="n">initialStateDetuningX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">br</span><span class="p">])</span>
        

        <span class="n">initialStateDetuning</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">))</span><span class="c1">##*1e9</span>
        <span class="n">initialStateDetuningX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">)</span>
        
        
        <span class="k">def</span> <span class="nf">c3fit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c3</span><span class="p">,</span><span class="n">offset</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">c3</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">3</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span>
        
        <span class="c1"># print len(initialStateDetuningX)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span><span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">c3fit</span><span class="p">,</span>\
                              <span class="n">initialStateDetuningX</span><span class="p">,</span>\
                              <span class="n">initialStateDetuning</span><span class="p">,</span>\
                              <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: unable to find a fit for C3.&quot;</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="nb">print</span> <span class="s2">&quot;c3 = &quot;</span><span class="p">,</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s2">&quot; GHz /R^3 (mu m)^3&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;offset = &quot;</span><span class="p">,</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">y_fit</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">initialStateDetuningX</span><span class="p">:</span>
            <span class="n">y_fit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c3fit</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">y_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_fit</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">showPlot</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">8.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">),</span>\
                      <span class="s2">&quot;b-&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_fit</span><span class="p">),</span>\
                      <span class="s2">&quot;r--&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s2">&quot;calculated energy level&quot;</span><span class="p">,</span><span class="s2">&quot;fitted model function&quot;</span><span class="p">),</span>\
                      <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">),</span>\
                        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">)</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span> <span class="n">exp</span><span class="p">(</span><span class="n">ymin</span><span class="p">),</span><span class="n">exp</span><span class="p">(</span><span class="n">ymax</span><span class="p">))</span>
            
            
            
            <span class="c1">#ax.grid()</span>
            <span class="c1">#ax.grid(which=&#39;minor&#39;, color=&#39;0.5&#39;, linestyle=&#39;:&#39;)</span>
            
            <span class="n">minorLocator</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">minorFormatter</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">minorLocator</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span><span class="n">minorFormatter</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">NullFormatter</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">r&quot;Interatomic distance, $r$ ($\mu$m)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">r&quot;Pair-state energy, $|E|$ (GHz)&quot;</span><span class="p">)</span>
            
            <span class="n">locatorStep</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">locatorStep</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">))</span> <span class="ow">and</span> <span class="n">locatorStep</span><span class="o">&gt;</span><span class="mf">1.e-4</span><span class="p">:</span>
                <span class="n">locatorStep</span> <span class="o">/=</span> <span class="mf">10.</span>
            
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">locatorStep</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">locatorStep</span><span class="o">/</span><span class="mf">10.</span><span class="p">))</span>
            <span class="c1">#ax.yaxis.set_minor_formatter(mpl.ticker.FormatStrFormatter(&#39;%.3f&#39;))</span>
            
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">r&quot;$C_3$ fit&quot;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
                
        <span class="bp">self</span><span class="o">.</span><span class="n">fitX</span> <span class="o">=</span> <span class="n">initialStateDetuningX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitY</span> <span class="o">=</span> <span class="n">initialStateDetuning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fittedCurveY</span> <span class="o">=</span> <span class="n">y_fit</span>
            
        <span class="k">return</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="PairStateInteractions.getVdwFromLevelDiagram"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.PairStateInteractions.getVdwFromLevelDiagram">[docs]</a>    <span class="k">def</span> <span class="nf">getVdwFromLevelDiagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rStart</span><span class="p">,</span><span class="n">rStop</span><span class="p">,</span><span class="n">showPlot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>\
                              <span class="n">minStateContribution</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Finds :math:`r_{\\rm vdW}` coefficient for original pair state.</span>
<span class="sd">            </span>
<span class="sd">            Function first finds for each distance in the range [`rStart`,`rStop`] </span>
<span class="sd">            the eigen state with highest contribution of the original state. </span>
<span class="sd">            One can set optional parameter `minStateContribution` to value in </span>
<span class="sd">            the range [0,1), so that function finds only states if they have </span>
<span class="sd">            contribution of the original state that is bigger then </span>
<span class="sd">            `minStateContribution`.</span>
<span class="sd">            </span>
<span class="sd">            Once original pair-state is found in the range of interatomic </span>
<span class="sd">            distances, from smallest `rStart` to the biggest `rStop`, function</span>
<span class="sd">            will try to perform fitting of the corresponding state energy </span>
<span class="sd">            :math:`E(R)` at distance :math:`R` to the function </span>
<span class="sd">            :math:`A+B\\frac{1-\\sqrt{1+(r_{\\rm vdW}/r)^6}}{1-\\sqrt{1+r_{\\rm vdW}^6}}`</span>
<span class="sd">             where :math:`A` and :math:`B` are some offset. </span>
<span class="sd">                </span>
<span class="sd">            Args:</span>
<span class="sd">                rStart (float): smallest inter-atomic distance to be used for fitting</span>
<span class="sd">                rStop (float): maximum inter-atomic distance to be used for fitting</span>
<span class="sd">                showPlot (bool): If set to true, it will print the plot showing</span>
<span class="sd">                    fitted energy level and the obtained best fit. Default is</span>
<span class="sd">                    False</span>
<span class="sd">                minStateContribution (float): valid values are in the range [0,1).</span>
<span class="sd">                    It specifies minimum amount of the original state in the given</span>
<span class="sd">                    energy state necessary for the state to be considered for</span>
<span class="sd">                    the adiabatic continuation of the original unperturbed </span>
<span class="sd">                    pair state.</span>
<span class="sd">            Returns:</span>
<span class="sd">                float:</span>
<span class="sd">                    :math:`r_{\\rm vdW}`  measured in :math:`\\mu\\text{m}`</span>
<span class="sd">                    on success; If unsuccessful returns False. </span>
<span class="sd">                </span>
<span class="sd">            Note:</span>
<span class="sd">                In order to use this functions, highlighting in </span>
<span class="sd">                :obj:`diagonalise` should be based on the original pair </span>
<span class="sd">                state contribution of the eigenvectors (that this, </span>
<span class="sd">                `drivingFromState` parameter should not be set, which </span>
<span class="sd">                corresponds to `drivingFromState` = [0,0,0,0,0]).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">initialStateDetuning</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">initialStateDetuningX</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">fromRindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">toRindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fromRindex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">br</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">rStart</span><span class="p">):</span> 
                <span class="n">fromRindex</span> <span class="o">=</span> <span class="n">br</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">br</span><span class="p">]</span><span class="o">&gt;</span><span class="n">rStop</span><span class="p">):</span>
                <span class="n">toRindex</span> <span class="o">=</span> <span class="n">br</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fromRindex</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">toRindex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">toRindex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fromRindex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERROR: could not find data for energy levels for interatomic&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;distances between %2.f and </span><span class="si">%.2f</span><span class="s2"> mu m.</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rStart</span><span class="p">,</span><span class="n">rStop</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="n">discontinuityDetected</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">toRindex</span><span class="p">,</span><span class="n">fromRindex</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">maxPortion</span> <span class="o">=</span> <span class="n">minStateContribution</span>
            <span class="k">for</span> <span class="n">br2</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">br</span><span class="p">])):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">br2</span><span class="p">])</span><span class="o">&gt;</span><span class="n">maxPortion</span><span class="p">):</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">br2</span>
                    <span class="n">maxPortion</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">br2</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">slope1</span> <span class="o">=</span> <span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">initialStateDetuning</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span>\
                        <span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">initialStateDetuningX</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">slope2</span> <span class="o">=</span>  <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">index</span><span class="p">])</span><span class="o">-</span><span class="n">initialStateDetuning</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span>\
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">br</span><span class="p">]</span><span class="o">-</span><span class="n">initialStateDetuningX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slope2</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">3.</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">slope1</span><span class="p">):</span>
                    <span class="n">discontinuityDetected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">discontinuityDetected</span><span class="p">):</span>
                <span class="n">initialStateDetuning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">br</span><span class="p">][</span><span class="n">index</span><span class="p">]))</span>
                <span class="n">initialStateDetuningX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">br</span><span class="p">])</span>


        <span class="n">initialStateDetuning</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">)))</span>
        <span class="n">initialStateDetuningX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">vdwFit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">scale</span><span class="p">,</span><span class="n">vdw</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">scale</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">vdw</span><span class="o">/</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">vdw</span><span class="o">**</span><span class="mi">6</span><span class="p">))))</span>
  
        
        <span class="n">noOfPoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Data points to fit = &quot;</span><span class="p">,</span><span class="n">noOfPoints</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span><span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">vdwFit</span><span class="p">,</span>\
                              <span class="n">initialStateDetuningX</span><span class="p">,</span>\
                              <span class="n">initialStateDetuning</span><span class="p">,</span>\
                              <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">initialStateDetuning</span><span class="p">[</span><span class="n">noOfPoints</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>\
                               <span class="n">initialStateDetuningX</span><span class="p">[</span><span class="n">noOfPoints</span><span class="o">/</span><span class="mi">2</span><span class="p">]])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: unable to find a fit for van der Waals distance.&quot;</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">initialStateDetuningX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="nb">print</span> <span class="s2">&quot;WARNING: vdw radius seems to be outside the fitting range!&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;It&#39;s estimated to be around </span><span class="si">%.2f</span><span class="s2"> mu m from the current fit.&quot;</span><span class="o">%</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="nb">print</span> <span class="s2">&quot;Rvdw =  &quot;</span><span class="p">,</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s2">&quot; mu m&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;offset = &quot;</span><span class="p">,</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> scale = &quot;</span><span class="p">,</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">y_fit</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">initialStateDetuningX</span><span class="p">:</span>
            <span class="n">y_fit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vdwFit</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">y_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_fit</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">showPlot</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">8.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">),</span>\
                      <span class="s2">&quot;b-&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#ax.loglog(initialStateDetuningX,initialStateDetuning,\</span>
            <span class="c1">#          &quot;b-&quot;,lw=2,zorder=1)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">initialStateDetuningX</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_fit</span><span class="p">),</span>\
                      <span class="s2">&quot;r--&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1">#ax.loglog(initialStateDetuningX,y_fit,\</span>
            <span class="c1">#          &quot;r--&quot;,lw=2,zorder=2)</span>
            <span class="c1">#loglog(initialStateDetuningX[150:250],y_theory,&quot;k:&quot;)</span>
            <span class="c1">#xlim(0.9,10)</span>
            <span class="c1">#ylim(1e2,1e12)</span>
            
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">),</span>\
                        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">)</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">initialStateDetuning</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span> <span class="n">exp</span><span class="p">(</span><span class="n">ymin</span><span class="p">),</span><span class="n">exp</span><span class="p">(</span><span class="n">ymax</span><span class="p">))</span>
            
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">exp</span><span class="p">((</span><span class="n">ymin</span><span class="o">+</span><span class="n">ymax</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span><span class="s2">r&quot;$R_</span><span class="si">{vdw}</span><span class="s2"> = </span><span class="si">%.1f</span><span class="s2">$ $\mu$m&quot;</span> <span class="o">%</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            
            <span class="c1">#ax.grid()</span>
            <span class="c1">#ax.grid(which=&#39;minor&#39;, color=&#39;0.5&#39;, linestyle=&#39;:&#39;)</span>
            
            
            
            <span class="n">minorLocator</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">minorFormatter</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">minorLocator</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span><span class="n">minorFormatter</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">NullFormatter</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">r&quot;Interatomic distance, $r$ ($\mu$m)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">r&quot;Pair-state energy, $|E|$ (GHz)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s2">&quot;calculated energy level&quot;</span><span class="p">,</span><span class="s2">&quot;fitted model function&quot;</span><span class="p">),</span>\
                      <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
             
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
                
        <span class="bp">self</span><span class="o">.</span><span class="n">fitX</span> <span class="o">=</span> <span class="n">initialStateDetuningX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitY</span> <span class="o">=</span> <span class="n">initialStateDetuning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fittedCurveY</span> <span class="o">=</span> <span class="n">y_fit</span>   
            
        <span class="k">return</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="StarkMapResonances"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.StarkMapResonances">[docs]</a><span class="k">class</span> <span class="nc">StarkMapResonances</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates pair state Stark maps for finding resonances</span>
<span class="sd">    </span>
<span class="sd">        Tool for finding conditions for Foster resonances. For a given pair</span>
<span class="sd">        state, in a given range of the electric fields, looks for the pair-state</span>
<span class="sd">        that are close in energy and coupled via dipole-dipole interactions</span>
<span class="sd">        to the original pair-state.</span>
<span class="sd">        </span>
<span class="sd">        See `Stark resonances example snippet`_.</span>
<span class="sd">        </span>
<span class="sd">        .. _`Stark resonances example snippet`:</span>
<span class="sd">                ././Rydberg_atoms_a_primer.html#Tuning-the-interaction-strength-with-electric-fields</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            atom (:obj:`AlkaliAtom`): ={ :obj:`alkali_atom_data.Lithium6`, </span>
<span class="sd">                :obj:`alkali_atom_data.Lithium6`,</span>
<span class="sd">                :obj:`alkali_atom_data.Sodium`,</span>
<span class="sd">                :obj:`alkali_atom_data.Potassium`,</span>
<span class="sd">                :obj:`alkali_atom_data.Rubidium`,</span>
<span class="sd">                :obj:`alkali_atom_data.Caesium` } </span>
<span class="sd">                 the first atom in the pair-state</span>
<span class="sd">            state1 ([int,int,float,float]): specification of the state</span>
<span class="sd">                of the first state as an array of values :math:`[n,l,j,m_j]`</span>
<span class="sd">            atom (:obj:`AlkaliAtom`): ={ :obj:`alkali_atom_data.Lithium6`, </span>
<span class="sd">                :obj:`alkali_atom_data.Lithium6`,</span>
<span class="sd">                :obj:`alkali_atom_data.Sodium`,</span>
<span class="sd">                :obj:`alkali_atom_data.Potassium`,</span>
<span class="sd">                :obj:`alkali_atom_data.Rubidium`,</span>
<span class="sd">                :obj:`alkali_atom_data.Caesium` } </span>
<span class="sd">                 the second atom in the pair-state</span>
<span class="sd">            state2 ([int,int,float,float]): specification of the state</span>
<span class="sd">                of the first state as an array of values :math:`[n,l,j,m_j]`      </span>
<span class="sd">        </span>
<span class="sd">        Note:</span>
<span class="sd">            In checking if certain state is dipole coupled to the original </span>
<span class="sd">            state, only the highest contributing state is checked for dipole</span>
<span class="sd">            coupling. This should be fine if one is interested in resonances</span>
<span class="sd">            in weak fields. For stronger fields, one might want to include</span>
<span class="sd">            effect of coupling to other contributing base states.</span>
<span class="sd">        </span>
<span class="sd">                      </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">atom1</span><span class="p">,</span><span class="n">state1</span><span class="p">,</span><span class="n">atom2</span><span class="p">,</span><span class="n">state2</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atom1</span> <span class="o">=</span> <span class="n">atom1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state1</span> <span class="o">=</span> <span class="n">state1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom2</span> <span class="o">=</span> <span class="n">atom2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state2</span> <span class="o">=</span> <span class="n">state2</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pairStateEnergy</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">getEnergy</span><span class="p">(</span><span class="o">*</span><span class="n">state1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span>\
                                <span class="n">atom2</span><span class="o">.</span><span class="n">getEnergy</span><span class="p">(</span><span class="o">*</span><span class="n">state2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>\
                            <span class="o">*</span><span class="n">elemCharge</span><span class="o">/</span><span class="n">h</span><span class="o">*</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">9</span>
        
<div class="viewcode-block" id="StarkMapResonances.findResonances"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.StarkMapResonances.findResonances">[docs]</a>    <span class="k">def</span> <span class="nf">findResonances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nMin</span><span class="p">,</span><span class="n">nMax</span><span class="p">,</span><span class="n">maxL</span><span class="p">,</span><span class="n">eFieldList</span><span class="p">,</span><span class="n">energyRange</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">5.e9</span><span class="p">,</span><span class="o">+</span><span class="mf">5.e9</span><span class="p">],</span>\
             <span class="n">progressOutput</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Finds near-resonant dipole-coupled pair-states</span>
<span class="sd">            </span>
<span class="sd">            For states in range of principal quantum numbers [`nMin`,`nMax`]</span>
<span class="sd">            and orbital angular momentum [0,`maxL`], for a range of electric fields</span>
<span class="sd">            given by `eFieldList` function will find near-resonant pair states.</span>
<span class="sd">            </span>
<span class="sd">            Only states that are in the range given by `energyRange` will be </span>
<span class="sd">            extracted from the pair-state Stark maps.</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                nMin (int): minimal principal quantum number of the state to be </span>
<span class="sd">                    included in the StarkMap calculation</span>
<span class="sd">                nMax (int): maximal principal quantum number of the state to be </span>
<span class="sd">                    included in the StarkMap calculation</span>
<span class="sd">                maxL (int): maximum value of orbital angular momentum for the states</span>
<span class="sd">                    to be included in the calculation</span>
<span class="sd">                eFieldList ([float]): list of the electric fields (in V/m) for</span>
<span class="sd">                    which to calculate level diagram (StarkMap)</span>
<span class="sd">                energyRange ([float,float]): optinal argument. Minimal and maximal</span>
<span class="sd">                    energy of that some dipole-coupled state should have in order</span>
<span class="sd">                    to keep it in the plot (in units of Hz). By default it finds</span>
<span class="sd">                    states that are :math:`\pm 5` GHz</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">eFieldList</span> <span class="o">=</span> <span class="n">eFieldList</span>
        <span class="n">eMin</span> <span class="o">=</span> <span class="n">energyRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.e-9</span>  <span class="c1"># in GHz</span>
        <span class="n">eMax</span> <span class="o">=</span> <span class="n">energyRange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1.e-9</span>
        
        <span class="c1"># find where is the original pair state</span>
        
        <span class="n">sm1</span> <span class="o">=</span> <span class="n">StarkMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom1</span><span class="p">)</span>
        <span class="n">sm1</span><span class="o">.</span><span class="n">defineBasis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">nMin</span><span class="p">,</span> <span class="n">nMax</span><span class="p">,</span> <span class="n">maxL</span><span class="p">,</span> \
                        <span class="n">progressOutput</span> <span class="o">=</span> <span class="n">progressOutput</span><span class="p">)</span>
        <span class="n">sm1</span><span class="o">.</span><span class="n">diagonalise</span><span class="p">(</span><span class="n">eFieldList</span><span class="p">,</span>  <span class="n">progressOutput</span> <span class="o">=</span> <span class="n">progressOutput</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom1</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="p">):</span>
            <span class="n">sm2</span> <span class="o">=</span> <span class="n">sm1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sm2</span> <span class="o">=</span> <span class="n">StarkMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom2</span><span class="p">)</span>
            <span class="n">sm2</span><span class="o">.</span><span class="n">defineBasis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">nMin</span><span class="p">,</span> <span class="n">nMax</span><span class="p">,</span> <span class="n">maxL</span><span class="p">,</span> \
                            <span class="n">progressOutput</span> <span class="o">=</span> <span class="n">progressOutput</span><span class="p">)</span>
            <span class="n">sm2</span><span class="o">.</span><span class="n">diagonalise</span><span class="p">(</span><span class="n">eFieldList</span><span class="p">,</span>  <span class="n">progressOutput</span> <span class="o">=</span> <span class="n">progressOutput</span><span class="p">)</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">originalStateY</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originalStateContribution</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sm1</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">)):</span>
            <span class="n">jmax1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">jmax2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sm1</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sm1</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="n">sm1</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jmax1</span><span class="p">]):</span>
                    <span class="n">jmax1</span> <span class="o">=</span> <span class="n">j</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sm2</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sm2</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="n">sm2</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jmax2</span><span class="p">]):</span>
                    <span class="n">jmax2</span> <span class="o">=</span> <span class="n">j</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">originalStateY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sm1</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jmax1</span><span class="p">]</span><span class="o">+</span><span class="n">sm2</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jmax2</span><span class="p">]</span><span class="o">-</span>\
                                        <span class="bp">self</span><span class="o">.</span><span class="n">pairStateEnergy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">originalStateContribution</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sm1</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jmax1</span><span class="p">]</span><span class="o">+</span>\
                                                   <span class="n">sm2</span><span class="o">.</span><span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jmax2</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            
        <span class="c1"># M= mj1+mj2 is conserved with dipole-dipole interaction</span>
        
        <span class="n">dmlist1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">dmlist1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dmlist2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">dmlist2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">mj1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">j2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">mj2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;mymap&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;0.9&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;black&#39;</span><span class="p">])</span>
        <span class="n">cNorm</span>  <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">dm1</span> <span class="ow">in</span> <span class="n">dmlist1</span><span class="p">:</span>
            <span class="n">sm1</span><span class="o">.</span><span class="n">defineBasis</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">mj1</span><span class="o">+</span><span class="n">dm1</span><span class="p">,</span> <span class="n">nMin</span><span class="p">,</span> <span class="n">nMax</span><span class="p">,</span> <span class="n">maxL</span><span class="p">,</span> \
                        <span class="n">progressOutput</span> <span class="o">=</span> <span class="n">progressOutput</span><span class="p">)</span>
            <span class="n">sm1</span><span class="o">.</span><span class="n">diagonalise</span><span class="p">(</span><span class="n">eFieldList</span><span class="p">,</span>  <span class="n">progressOutput</span> <span class="o">=</span> <span class="n">progressOutput</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">dm2</span> <span class="ow">in</span> <span class="n">dmlist2</span><span class="p">:</span>
                <span class="n">sm2</span><span class="o">.</span><span class="n">defineBasis</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="n">mj2</span><span class="o">+</span><span class="n">dm2</span><span class="p">,</span> <span class="n">nMin</span><span class="p">,</span> <span class="n">nMax</span><span class="p">,</span> <span class="n">maxL</span><span class="p">,</span> \
                            <span class="n">progressOutput</span> <span class="o">=</span> <span class="n">progressOutput</span><span class="p">)</span>
                <span class="n">sm2</span><span class="o">.</span><span class="n">diagonalise</span><span class="p">(</span><span class="n">eFieldList</span><span class="p">,</span>  <span class="n">progressOutput</span> <span class="o">=</span> <span class="n">progressOutput</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sm1</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">)):</span>
                    <span class="n">yList</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">compositionList</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">progressOutput</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">E=</span><span class="si">%.2f</span><span class="s2"> V/m &quot;</span> <span class="o">%</span> <span class="n">sm1</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sm1</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sm2</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                            <span class="n">energy</span> <span class="o">=</span> <span class="n">sm1</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">sm2</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span>\
                                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pairStateEnergy</span>
                            <span class="n">statec1</span> <span class="o">=</span> <span class="n">sm1</span><span class="o">.</span><span class="n">basisStates</span><span class="p">[</span><span class="n">sm1</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="n">statec2</span> <span class="o">=</span> <span class="n">sm2</span><span class="o">.</span><span class="n">basisStates</span><span class="p">[</span><span class="n">sm2</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>                            
                            <span class="k">if</span> <span class="p">(</span><span class="n">energy</span><span class="o">&gt;</span><span class="n">eMin</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">energy</span><span class="o">&lt;</span><span class="n">eMax</span><span class="p">)</span> <span class="ow">and</span>\
                                <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">statec1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">state1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span>\
                                <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">statec2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">state2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                                <span class="c1"># add this to PairStateMap</span>
                                <span class="n">yList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
                                <span class="n">compositionList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                                    <span class="n">sm1</span><span class="o">.</span><span class="n">_stateComposition</span><span class="p">(</span><span class="n">sm1</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]),</span>
                                    <span class="n">sm2</span><span class="o">.</span><span class="n">_stateComposition</span><span class="p">(</span><span class="n">sm2</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">])])</span>                
                    
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yList</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compositionList</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">yList</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">compositionList</span><span class="p">)</span>   
                                     
                <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sm1</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">)):</span>
            <span class="c1">#print (&quot; plotting %d&quot; % i)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">sm1</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>\
                                <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="n">cNorm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sm1</span><span class="o">.</span><span class="n">eFieldList</span><span class="o">/</span><span class="mf">100.</span><span class="p">,</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">originalStateY</span><span class="p">,</span><span class="s2">&quot;r-&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">eMin</span><span class="p">,</span><span class="n">eMax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span><span class="p">,</span>\
                         <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Electric field (V/cm)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Pair-state relative energy, $\Delta E/h$ (GHz)&quot;</span><span class="p">)</span></div>
        <span class="c1">#plt.show()</span>
        <span class="c1">#return 0</span>
        
<div class="viewcode-block" id="StarkMapResonances.showPlot"><a class="viewcode-back" href="../calculations_atom_pairstate.html#calculations_atom_pairstate.StarkMapResonances.showPlot">[docs]</a>    <span class="k">def</span> <span class="nf">showPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Plots initial state Stark map and its dipole-coupled resonances</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">            </span>
<span class="sd">                interactive (optional, bool): if True (by default) points on plot</span>
<span class="sd">                    will be clickable so that one can find the state labels</span>
<span class="sd">                    and their composition (if they are heavily admixed).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Click on state to see state composition&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clickedPoint</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;pick_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onPick</span><span class="p">)</span>
                <span class="c1">#self._onPick2(0.18,0.02)</span>
                <span class="c1">#plt.savefig(&quot;foster.pdf&quot;, bbox_inches=&#39;tight&#39;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Error while showing a plot: nothing is plotted yet&quot;</span></div>

    <span class="k">def</span> <span class="nf">_onPick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">PathCollection</span><span class="p">):</span>
            
            <span class="n">x</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">mouseevent</span><span class="o">.</span><span class="n">xdata</span><span class="o">*</span><span class="mf">100.</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">mouseevent</span><span class="o">.</span><span class="n">ydata</span>
            
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span>\
                           <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">))):</span>
                <span class="n">i</span> <span class="o">-=</span><span class="mi">1</span>
            
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">)):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">jj</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clickedPoint</span><span class="o">!=</span><span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clickedPoint</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">clickedPoint</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">],</span>\
                                               <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]],</span><span class="s2">&quot;bs&quot;</span><span class="p">,</span>\
                                                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            
            <span class="n">atom1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">elementName</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">elementName</span>
            <span class="n">composition1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">composition2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">((</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">]=[&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span><span class="n">atom2</span><span class="p">))</span><span class="o">+</span>\
                              <span class="n">composition1</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span>\
                              <span class="n">composition2</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span>
                             <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
            <span class="n">event</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_onPick2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">):</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            
            <span class="n">x</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">*</span><span class="mf">100.</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">ydata</span>
            
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span>\
                           <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">))):</span>
                <span class="n">i</span> <span class="o">-=</span><span class="mi">1</span>
            
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">)):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">jj</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clickedPoint</span><span class="o">!=</span><span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clickedPoint</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">clickedPoint</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">eFieldList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">],</span>\
                                               <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]],</span><span class="s2">&quot;bs&quot;</span><span class="p">,</span>\
                                                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            
            <span class="n">atom1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">elementName</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">elementName</span>
            <span class="n">composition1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">composition2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">((</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">]=[&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span><span class="n">atom2</span><span class="p">))</span><span class="o">+</span>\
                              <span class="n">composition1</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span>\
                              <span class="n">composition2</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span>
                             <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>
        
            <span class="c1">#event.canvas.draw()</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Nikola Šibalić.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.9 beta',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>